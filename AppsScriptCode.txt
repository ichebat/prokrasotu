const DOC_ID = '1JPSzoAEUktlPgShanrrdZs3Vb5YwQVzlTeog8JmzWrI';
const API_TOKEN = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B1").getValue().toString();//—Ç–æ–∫–µ–Ω –æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º–º
const telegramUrl = "https://api.telegram.org/bot" + API_TOKEN;
var App_link = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B2").getValue().toString();// URL –¥–ª—è WebHook;
const MOMENTJS_link = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B3").getValue().toString();
const WEB_APP_URL = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B5").getValue().toString();//Web App Url –¥–ª—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ Angular
const TimeZoneHours = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B6").getValue();//—Å–¥–≤–∏–≥ –≤ —á–∞—Å–∞—Ö –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
const chat_id_master = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B7").getValue();//chat id –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
const max_archive_length = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B8").getValue();//–µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ–ª—å—à–µ –∑–∞–∫–∞–∑–æ–≤ —á–µ–º —ç—Ç–∞ –≤–µ–ª–∏—á–∏–Ω–∞ —Ç–æ —Å—Ç–∞—Ä—ã–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –±—É–¥—É—Ç —É—Ö–æ–¥–∏—Ç—å –≤ –∞—Ä—Ö–∏–≤
const PROVIDER_TOKEN = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B9").getValue();//–¢–æ–∫–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã



const thisBotName = "ProKrasotuBot"; // –∏–º—è –±–æ—Ç–∞ (–±–µ–∑ @) –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –ø—Ä–∏ –Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ø–æ–ª–Ω–æ–º–æ—á–∏–π (—á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Ç–∞—Ç—å—Å—è)
//—Å—Ç—Ä–æ–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è "–ß—Ç–æ —É–º–µ–µ—Ç —ç—Ç–æ—Ç –±–æ—Ç?"
const HELLO_BOT_STRING = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B4").getValue().toString();
//"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ. –ò—Å–ø–æ–ª—å–∑—É—è –±–æ—Ç https://t.me/"+thisBotName+ " –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–æ–≤. \n–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.";

//–≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ª–∏—Å—Ç–∞—Ö
const CMD_ROW_UPDATE = 0;
const CMD_ROW_INSERT = 1;
const CMD_ROW_GET = 2;
const CMD_ROW_FILTER = 3;
const CMD_ROW_DELETE = 4;

const LOG_SHEET_NAME = '–õ–æ–≥';
const CART_SHEET_NAME = '–ö–æ—Ä–∑–∏–Ω–∞';
const PRODUCT_SHEET_NAME = '–ü—Ä–æ–¥—É–∫—Ç—ã'
const DELIVERY_SHEET_NAME = '–î–æ—Å—Ç–∞–≤–∫–∞'
const ORDER_SHEET_NAME = '–ó–∞–∫–∞–∑—ã'
const ARCHIVE_ORDER_SHEET_NAME = '–ó–∞–∫–∞–∑—ã –∞—Ä—Ö–∏–≤'

const LOG_SHEET_INDEX = 0;
const CART_SHEET_INDEX = 1;
const PRODUCT_SHEET_INDEX = 2
const DELIVERY_SHEET_INDEX = 3
const ORDER_SHEET_INDEX = 4
const ARCHIVE_ORDER_SHEET_INDEX = 5


//–õ–∏—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å
//–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é prepareSheetsAndColumns
const SHEETS_TO_CREATE = [LOG_SHEET_NAME,PRODUCT_SHEET_NAME,CART_SHEET_NAME,DELIVERY_SHEET_NAME,ORDER_SHEET_NAME,ARCHIVE_ORDER_SHEET_NAME];

const COLUMNS_ARRAY =[
  ["–õ–æ–≥ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è"],
  ["–ù–æ–º–µ—Ä –ø–æ –ø–æ—Ä—è–¥–∫—É", "–°—Å—ã–ª–∫–∞, –¥–ª—è –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö", "–ê—Ä—Ç–∏–∫—É–ª", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (—Ç–∏–ø)", "–ë—Ä–µ–Ω–¥", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–û–ø–∏—Å–∞–Ω–∏–µ", "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ", "–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É", "–¶–µ–Ω–∞ (—Ä—É–±.)", "–°–∫–∏–¥–∫–∞ (%)", "–ù–æ–≤–∏–Ω–∫–∞?"],
  ["–ö–æ–¥", "chat_id", "–ò–º—è –≤ —Ç–µ–ª–µ–≥—Ä–∞–º", "–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", " –ö–æ—Ä–∑–∏–Ω–∞ (JSON)" ],
  ["–ö–æ–¥", "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏", "–û–ø–∏—Å–∞–Ω–∏–µ", "–°—Ç–æ–∏–º–æ—Å—Ç—å", "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ –ø—Ä–∏ —Å—É–º–º–µ –∑–∞–∫–∞–∑–∞", "–°—Ç—Ä–æ–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ dadata", "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É (0 - –Ω–µ—Ç, 1 - –¥–∞)","–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞ (0 - –Ω–µ—Ç, 1 - –¥–∞)", "–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É"],
  //["–ö–æ–¥","chat_id","–ò–º—è –≤ telegram","–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è","–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤","–ò—Ç–æ–≥–æ —Ü–µ–Ω–∞","–ò—Ç–æ–≥–æ –∫–æ–ª-–≤–æ","–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞","–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ telegram","–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞","–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏","–î–æ—Å—Ç–∞–≤–∫–∞","–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞","–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤ –º–∞–≥–∞–∑–∏–Ω–µ?","–î–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è","–ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω?","–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è","–ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω–µ–Ω?","–î–∞—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è","–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è","–ó–∞–∫–∞–∑ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ?","–î–∞—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏","–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏","–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É"]
  ["–ö–æ–¥","chat_id","–ò–º—è –≤ telegram","–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è","–ó–∞–∫–∞–∑ (JSON)"],
  ["–ö–æ–¥","–ó–∞–∫–∞–∑ (JSON)","–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞#id","–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤#items","–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤#totalAmount", "–ö–æ–ª-–≤–æ —Ç–æ–≤–∞—Ä–æ–≤#totalCount","–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞#clientName","chat_id#clientTgChatId","–ù–∏–∫ –≤ Tg#clientTgName","–¢–µ–ª–µ—Ñ–æ–Ω#clientPhone","–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏#clientAddress","–î–æ—Å—Ç–∞–≤–∫–∞#delivery","–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞#orderDate","–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤ –º–∞–≥–∞–∑–∏–Ω–µ?#isAccepted","–î–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è#acceptDate","–ó–∞–≤–µ—Ä—à–µ–Ω?#isCompleted","–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è#completeDate","–û—Ç–º–µ–Ω–µ–Ω?#isCancelled","–î–∞—Ç–∞ –æ—Ç–º–µ–Ω—ã#cancellationDate","–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã#cancellationReason","–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω?#isCorrected","–î–∞—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏#correctionDate","–ü—Ä–∏—á–∏–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏#correctionReason","–û–ø–∏—Å–∞–Ω–∏–µ#description","–û–ø–ª–∞—á–µ–Ω online?#isClientPay","–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã#clientPayDate","–ò–Ω—Ñ–æ –æ–± –æ–ø–ª–∞—Ç–µ#clientPayInfo"]
]

// const LOG_COLUMNS = ["–õ–æ–≥ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è"]; //–∫–æ–ª–æ–Ω–∫–∏ –≤ –ª–∏—Å—Ç–µ –õ–æ–≥
// const PRODUCTS_COLUMNS = ["–ù–æ–º–µ—Ä –ø–æ –ø–æ—Ä—è–¥–∫—É", "–°—Å—ã–ª–∫–∞, –¥–ª—è –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö", "–ê—Ä—Ç–∏–∫—É–ª", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (—Ç–∏–ø)", "–ë—Ä–µ–Ω–¥", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–û–ø–∏—Å–∞–Ω–∏–µ", "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ", "–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É", "–¶–µ–Ω–∞ (—Ä—É–±.)", "–°–∫–∏–¥–∫–∞ (%)", "–ù–æ–≤–∏–Ω–∫–∞?"]; //–∫–æ–ª–æ–Ω–∫–∏ –≤ –ª–∏—Å—Ç–µ –ü—Ä–æ–¥—É–∫—Ç—ã

var isAdmin = false;

var KEYBOARD;
var KEYBOARD_ON_CHAT;
var KEYBOARD_ON_CHAT_ADMIN;
var REMOVE_KEYBOARD;


function setWebhook() {
  App_link = SpreadsheetApp.openById(DOC_ID).getSheetByName("SD").getRange("B2").getValue().toString();
  var url = telegramUrl + "/setWebhook?url=" + App_link;
  var response = UrlFetchApp.fetch(url);
}



function send (msg, chat_id)
{
  //–≤—Å–µ —Ä–∞–≤–Ω–æ –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è
  if (msg == "") return;

//–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–ª–≥. –ù–∞ –≤—Ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ ID —á–∞—Ç–∞, –≤ –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫—É
var payload = {
'method': 'sendMessage',
'chat_id': String(chat_id),
'text': msg,
'parse_mode': 'HTML'
} 
var data = {
"method": "post",
"payload": payload
}

try{
  UrlFetchApp.fetch('https://api.telegram.org/bot' + API_TOKEN + '/', data);
}
catch(e){};
//UrlFetchApp.fetch('https://api.telegram.org/bot' + API_TOKEN + '/', data);
}

// function getInvoice(id, deepLinkParameter, titleInvoice, descriptionInvoice, pricesList) {
//   const invoice = {
//     chat_id: id, // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–ª–µ–≤–æ–≥–æ —á–∞—Ç–∞ –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
//     provider_token: PROVIDER_TOKEN, // —Ç–æ–∫–µ–Ω –≤—ã–¥–∞–Ω–Ω—ã–π —á–µ—Ä–µ–∑ –±–æ—Ç @SberbankPaymentBot 
//     start_parameter: deepLinkParameter, //'get_access', //–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≥–ª—É–±–∏–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫. –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–ø–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∏–º–µ—Ç—å –∫–Ω–æ–ø–∫—É ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª, –ø–æ–∑–≤–æ–ª—è—é—â—É—é –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑ –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—è –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å—á–µ—Ç. –ï—Å–ª–∏ –Ω–µ –ø—É—Å—Ç–æ, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–ø–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∏–º–µ—Ç—å –∫–Ω–æ–ø–∫—É URL —Å –≥–ª—É–±–æ–∫–æ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –±–æ—Ç–∞ (–≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã) —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –≤ –∫–∞—á–µ—Å—Ç–≤–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.
//     title: titleInvoice, //'InvoiceTitle', // –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞, 1-32 —Å–∏–º–≤–æ–ª–∞
//     description: descriptionInvoice,//'InvoiceDescription', // –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞, 1-255 –∑–Ω–∞–∫–æ–≤
//     currency: 'RUB', // –¢—Ä–µ—Ö–±—É–∫–≤–µ–Ω–Ω—ã–π –∫–æ–¥ –≤–∞–ª—é—Ç—ã ISO 4217
//     prices: pricesList,//[{ label: 'Invoice Title', amount: 100 * 100 }], // –†–∞–∑–±–∏–≤–∫–∞ —Ü–µ–Ω, —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON 100 –∫–æ–ø–µ–µ–∫ * 100 = 100 —Ä—É–±–ª–µ–π
//     payload: { // –ü–æ–ª–µ–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–∞-—Ñ–∞–∫—Ç—É—Ä—ã, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –±–æ—Ç–æ–º, 1‚Äì128 –±–∞–π—Ç. –≠—Ç–æ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –¥–ª—è —Å–≤–æ–∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
//       unique_id: `${id}_${Number(new Date())}`,
//       provider_token: PROVIDER_TOKEN 
//     }
//   }

//   return invoice
// }

//—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É
//–µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç—å, —Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–º–æ–∂–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å
function sendAnswerPreCheckoutQuery(pre_checkout_query_id){
//–ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞–¥–æ –æ—Ç–≤–µ—Ç–∏—Ç—å
//   10.09.2024 16:00:13 919
// {
//      "update_id": 360414117,
//      "pre_checkout_query": {
//           "id": "5911616394385595828",
//           "from": {
//                "id": 1376405450,
//                "is_bot": false,
//                "first_name": "Ivan",
//                "last_name": "Che",
//                "username": "chebatz",
//                "language_code": "ru"
//           },
//           "currency": "RUB",
//           "total_amount": 30000,
//           "invoice_payload": "{provider_token=401643678:TEST:a6c2330c-dff9-4841-a551-5e35fc3fbc29, unique_id=1376405450_1725965867849}"
//      }
// }

 //–≤—Å–µ —Ä–∞–≤–Ω–æ –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è
  if (pre_checkout_query_id == "") return;
  var payload = {
    'pre_checkout_query_id': String(pre_checkout_query_id),
    'ok': 'True'
  }
  var data = {
    "method": "post",
    "payload": payload
  }

  try{
  UrlFetchApp.fetch('https://api.telegram.org/bot' + API_TOKEN + '/answerPreCheckoutQuery', data);
}
catch(e){};
//UrlFetchApp.fetch('https://api.telegram.org/bot' + API_TOKEN + '/answerPreCheckoutQuery', data);

}

function send_invoice (chat_id, orderId, deepLinkParameter, titleInvoice, descriptionInvoice, pricesList)
{

//–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–ª–≥. –ù–∞ –≤—Ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ ID —á–∞—Ç–∞, –≤ –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫—É
var payload = {
'method': 'sendInvoice',
'chat_id': String(chat_id),// –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–ª–µ–≤–æ–≥–æ —á–∞—Ç–∞ –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
'provider_token': PROVIDER_TOKEN,// —Ç–æ–∫–µ–Ω –≤—ã–¥–∞–Ω–Ω—ã–π —á–µ—Ä–µ–∑ –±–æ—Ç @SberbankPaymentBot 
'start_parameter': deepLinkParameter, //'get_access', //–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≥–ª—É–±–∏–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫. –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–ø–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∏–º–µ—Ç—å –∫–Ω–æ–ø–∫—É ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª, –ø–æ–∑–≤–æ–ª—è—é—â—É—é –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑ –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—è –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å—á–µ—Ç. –ï—Å–ª–∏ –Ω–µ –ø—É—Å—Ç–æ, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–ø–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∏–º–µ—Ç—å –∫–Ω–æ–ø–∫—É URL —Å –≥–ª—É–±–æ–∫–æ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –±–æ—Ç–∞ (–≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã) —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –≤ –∫–∞—á–µ—Å—Ç–≤–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.
'title': titleInvoice, //'InvoiceTitle', // –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞, 1-32 —Å–∏–º–≤–æ–ª–∞
'description': descriptionInvoice,//'InvoiceDescription', // –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞, 1-255 –∑–Ω–∞–∫–æ–≤
'currency': 'RUB', // –¢—Ä–µ—Ö–±—É–∫–≤–µ–Ω–Ω—ã–π –∫–æ–¥ –≤–∞–ª—é—Ç—ã ISO 4217
'prices': pricesList,//[{ label: 'Invoice Title', amount: 100 * 100 }], // –†–∞–∑–±–∏–≤–∫–∞ —Ü–µ–Ω, —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON 100 –∫–æ–ø–µ–µ–∫ * 100 = 100 —Ä—É–±–ª–µ–π
'payload': { // –ü–æ–ª–µ–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–∞-—Ñ–∞–∫—Ç—É—Ä—ã, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –±–æ—Ç–æ–º, 1‚Äì128 –±–∞–π—Ç. –≠—Ç–æ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –¥–ª—è —Å–≤–æ–∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
      unique_id: `${String(orderId)}_${String(chat_id)}_${Number(new Date())}`,
      provider_token: PROVIDER_TOKEN 
    },
'parse_mode': 'HTML',
} 
var data = {
"method": "post",
"payload": payload
}


try{
  UrlFetchApp.fetch('https://api.telegram.org/bot' + API_TOKEN + '/sendInvoice', data);
}
catch(e){};
//UrlFetchApp.fetch('https://api.telegram.org/bot' + API_TOKEN + '/sendInvoice', data);
}

function send_key (msg, chat_id, keyboard)
{
var payload = {
'method': 'sendMessage',
'chat_id': String(chat_id),
'text': msg,
'parse_mode': 'HTML',
reply_markup : JSON.stringify(keyboard)
}

if (msg === '')
{
  payload = {
'method': 'sendMessage',
'chat_id': String(chat_id),
reply_markup : JSON.stringify(keyboard)
}
}

var data = {
"method": "post",
"payload": payload
}
try{
  UrlFetchApp.fetch('https://api.telegram.org/bot' + API_TOKEN + '/', data);
}
catch(e){};
//UrlFetchApp.fetch('https://api.telegram.org/bot' + API_TOKEN + '/', data);

}




function testFunction(){
  //var result = "";
  var chat_id = "1376405450";
  //[{ label: 'Invoice Title', amount: 100 * 100 }], // –†–∞–∑–±–∏–≤–∫–∞ —Ü–µ–Ω, —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON 100 –∫–æ–ø–µ–µ–∫ * 100 = 100 —Ä—É–±–ª–µ–π
  //result = updateTableRow( DELIVERY_SHEET_NAME, [Array(COLUMNS_ARRAY[DELIVERY_SHEET_INDEX].length).fill("")], [], CMD_ROW_FILTER);
  //var invoice = getInvoice(chat_id, "_order_35", "–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ ‚Ññ35", "–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∑–∞–∫–∞–∑–∞ ‚Ññ35", [{ label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1', amount: 100 * 100 }, { label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2', amount: 200 * 100 }])
  
  //console.log(JSON.stringify(invoice));
  //send_invoice(chat_id, 35, "_order_35", "–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ ‚Ññ35", "–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∑–∞–∫–∞–∑–∞ ‚Ññ35", JSON.stringify([{ label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1', amount: 100 * 100 }, { label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2', amount: 200 * 100 }]))

  // udpateAllCartItems({'id':5,'url':'https://cehko.ru/catalog/kistochka/kistochka_c_ehko_bolshaya_chernaya_c_ehko_brush_big_black/','artikul':'12060','category':'–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã','type':'–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã','brand':'C:EHKO','name':'–ö–∏—Å—Ç–æ—á–∫–∞ C:EHKO –±–æ–ª—å—à–∞—è —á–µ—Ä–Ω–∞—è / C:EHKO BRUSH big black','description':'','dopolnitelno':'–í–µ—Å (–≥—Ä–∞–º–º): 20\n–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã\n–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: Gebrueder Ewald GmbH','imageUrl':'https://cehko.ru/upload/resize_cache/iblock/93b/1200_1200_140cd750bba9870f18aada2478b24840a/92aut8syt21o1ooxcvh9fama8xvst2r1.jpg','price':300,'discount':0,'isNew':'–ù–µ—Ç','translit':'kistochka-c-ehko-bolshaya-chernaya-c-ehko-brush-big-black'});

//   doPost({
//      "parameter": {},
//      "queryString": "",
//      "parameters": {},
//      "postData": {
//           "contents": JSON.stringify({
//      "update_id": 360414169,
//      "message": {
//           "message_id": 954,
//           "from": {
//                "id": 1376405450,
//                "is_bot": false,
//                "first_name": "Ivan",
//                "last_name": "Che",
//                "username": "chebatz",
//                "language_code": "ru"
//           },
//           "chat": {
//                "id": 1376405450,
//                "first_name": "Ivan",
//                "last_name": "Che",
//                "username": "chebatz",
//                "type": "private"
//           },
//           "date": 1726055948,
//           "successful_payment": {
//                "currency": "RUB",
//                "total_amount": 1000,
//                "invoice_payload": "{unique_id=1_1376405450_1726055886989, provider_token=401643678:TEST:a6c2330c-dff9-4841-a551-5e35fc3fbc29}",
//                "telegram_payment_charge_id": "6995875250_1376405450_67007",
//                "provider_payment_charge_id": "6995875250_1376405450_67007"
//           }
//      }
// }),
//           "length": 3291,
//           "name": "postData",
//           "type": "text/plain"
//      },
//      "contextPath": "",
//      "contentLength": 3291
// });

// doGet({
//      "parameter": {},
//      "queryString": "",
//      "parameters": {},
//      "postData": {
//           "contents": JSON.stringify({
//      "parameters": {
//           "chat_id": [
//                "619864883"
//           ],
//           "action": [
//                "getOrders"
//           ]
//      },
//      "parameter": {
//           "chat_id": "619864883",
//           "action": "getOrders"
//      },
//      "queryString": "action=getOrders&chat_id=619864883",
//      "contextPath": "",
//      "contentLength": -1
// }),
//           "length": 3291,
//           "name": "postData",
//           "type": "text/plain"
//      },
//      "contextPath": "",
//      "contentLength": 3291
// });

doGet({
     "parameters": {
          "chat_id": [
               "619864883"
          ],
          "action": [
               "getOrders"
          ]
     },
     "parameter": {
          "chat_id": "619864883",
          "action": "getOrders"
     },
     "queryString": "action=getOrders&chat_id=619864883",
     "contextPath": "",
     "contentLength": -1
});
}

function doGet(e){

  var result = "";
  //–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º moment —Ç–æ –Ω–µ –∑–∞–±—É–¥—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —á–µ—Ä–µ–∑ fetch
  
  //–ø–æ–¥–∫–ª—é—á–∞–µ–º moment.js –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
  eval(UrlFetchApp.fetch(MOMENTJS_link).getContentText());
  var update = e;
  updateTableRow( "–õ–æ–≥", [[(moment().format('DD.MM.YYYY HH:mm:ss SSS'))+"\n"+JSON.stringify(update, null, 5)]], [], CMD_ROW_UPDATE);//–ª–æ–≥–∏—Ä—É–µ–º 

  

  var chat_id = "";
  if (update.hasOwnProperty('parameter') && update.parameter.hasOwnProperty('chat_id')) chat_id = update.parameter.chat_id;

  isAdmin = checkIsAdmin(chat_id);

  var action = "";
  if (update.hasOwnProperty('parameter') && update.parameter.hasOwnProperty('action')) action = update.parameter.action;

  var cart = "";
  if (action.toString().toLowerCase()=='getcart')
  {
    if (chat_id)
    {
      var cart_row = updateTableRow( CART_SHEET_NAME, [[0, chat_id, "",(moment().format('DD.MM.YYYY HH:mm:ss SSS')), ""]], [1], CMD_ROW_GET);
      if (cart_row != null) cart = cart_row[0][4]; 
      result = cart;
    }
  }

  var orders = [];
  if (action.toString().toLowerCase()=='getorders')
  {
     
    if (chat_id)
    {
      var order_rows = null;
      
      //if (chat_id == chat_id_master) //–¥–ª—è master –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã
      if (isAdmin)
        order_rows = updateTableRow( ORDER_SHEET_NAME, [[0, "", "",(moment().format('DD.MM.YYYY HH:mm:ss SSS')), ""]], [], CMD_ROW_FILTER);
        else //–∏–Ω–∞—á–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ chat_id
        order_rows = updateTableRow( ORDER_SHEET_NAME, [[0, chat_id, "",(moment().format('DD.MM.YYYY HH:mm:ss SSS')), ""]], [1], CMD_ROW_FILTER);
      if (order_rows != null) 
      {
        console.log(order_rows.length);
        //order_rows.splice(chat_id != chat_id_master?order_rows.length-max_archive_length:0).forEach(row => {
        order_rows.splice(!isAdmin?order_rows.length-max_archive_length:0).forEach(row => {
          orders.push(row[4]);
      });
      }
      result = orders;
    }
  }

  var delivery=[];
  if (action.toString().toLowerCase()=='getdelivery')
  {
      var rows = updateTableRow( DELIVERY_SHEET_NAME, [Array(COLUMNS_ARRAY[DELIVERY_SHEET_INDEX].length).fill("")], [], CMD_ROW_FILTER);
      if (rows != null) rows.forEach(item=>{
        var deliveryItem = {
          id: item[0],
          name: item[1],
          description: item[2],
          amount: item[3],
          freeAmount: item[4],
        };
        delivery.push(deliveryItem)
      }); 
      result = delivery;
  }
  
  //—Å—Ç—Ä–æ–∫–∞ –Ω–∏–∂–µ –Ω—É–∂–Ω–∞ —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å CORS –æ—à–∏–±–∫—É –≤ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  
};

function doPost(e) {
  //–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º moment —Ç–æ –Ω–µ –∑–∞–±—É–¥—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —á–µ—Ä–µ–∑ fetch
  
  //return;
  
  //–ø–æ–¥–∫–ª—é—á–∞–µ–º moment.js –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
  eval(UrlFetchApp.fetch(MOMENTJS_link).getContentText());

  //—Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
  var update = JSON.parse(e.postData.contents);
  //var update = e; //–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –±—ã–ª–æ –≤—ã—à–µ

  updateTableRow( "–õ–æ–≥", [[(moment().format('DD.MM.YYYY HH:mm:ss SSS'))+"\n"+JSON.stringify(update, null, 5)]], [], CMD_ROW_UPDATE);//–ª–æ–≥–∏—Ä—É–µ–º 

    /*****
     * 
     * 
     * 
     * 
     * –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –æ–± –æ–ø–ª–∞—Ç–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –û–ö, —Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä
     * 
     * 
     * 
     */
  if (update.hasOwnProperty('pre_checkout_query')){
    var pre_checkout_query_id = "";
    if (update.pre_checkout_query.hasOwnProperty('id')) pre_checkout_query_id = update.pre_checkout_query.id;
    

    if (pre_checkout_query_id != "" && pre_checkout_query_id != null)
    {

      var chat_id = "";
      try
      {
        if (update.pre_checkout_query.hasOwnProperty('from'))
        {
          if (update.pre_checkout_query.from.hasOwnProperty('id')) chat_id = update.pre_checkout_query.from.id;
        }
      }
      catch(e){}

      var orderId = 0;
      try
      {
        //send("–ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω –ø–æ –∑–∞–∫–∞–∑—É "+update.pre_checkout_query.invoice_payload.toString().toLowerCase().slice(update.pre_checkout_query.invoice_payload.toString().toLowerCase().indexOf("unique_id")+10).split('_')[0], chat_id);
        orderId = parseInt(update.pre_checkout_query.invoice_payload.toString().toLowerCase().slice(update.pre_checkout_query.invoice_payload.toString().toLowerCase().indexOf("unique_id")+10).split('_')[0]);
        //JSON.parse(update.pre_checkout_query.invoice_payload).unique_id
      }
      catch(e){}

      if (orderId>0 && (""+chat_id).length>0)
      {
        var order = null;
        var order_row = updateTableRow( ORDER_SHEET_NAME, [[orderId, "", "","", ""]], [0], CMD_ROW_GET);
        if (order_row != null) order = JSON.parse(order_row[0][4]);
        if (order!= null)
        {
          //–∑–∞–∫–∞–∑ –º–æ–∂–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å
          if ( order.isAccepted && !order.isCompleted && !order.isCancelled)
          {
            if (!order.isClientPay){
              sendAnswerPreCheckoutQuery(pre_checkout_query_id);
            }
            else
            {
              send("–ó–∞–∫–∞–∑ —É–∂–µ –±—ã–ª –æ–ø–ª–∞—á–µ–Ω —Ä–∞–Ω–µ–µ", chat_id);
            }
            
          }
          else
          if ( order.isAccepted && order.isCompleted)
          {
            send("–ù–µ–ª—å–∑—è –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑", chat_id);
          }
          else
          if ( order.isAccepted && order.isCancelled)
          {
            send("–ù–µ–ª—å–∑—è –æ–ø–ª–∞—Ç–∏—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑", chat_id);
          }
          else
          if (!order.isAccepted && !order.isCompleted && !order.isCancelled)
          {
            send("–ù–µ–ª—å–∑—è –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ —É –ø—Ä–æ–¥–∞–≤—Ü–∞", chat_id);
          }
          else{
            send("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑", chat_id);
          }
        }       
      }
    }
  }

     /*****
     * 
     * 
     * 
     * 
     * –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
     * 
     * 
     * 
     */
  if (update.hasOwnProperty('message') && update.message.hasOwnProperty('successful_payment')){
    var msgForClient = "–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω!";
    var msgForSeller = "–ü–æ—Å—Ç—É–ø–∏–ª–∞ –æ–ø–ª–∞—Ç–∞ –∑–∞ –∑–∞–∫–∞–∑.";
    
    {
      var chat_id = "";
      try
      {
        if (update.message.hasOwnProperty('from'))
        {
          if (update.message.from.hasOwnProperty('id')) chat_id = update.message.from.id;
        }
      }
      catch(e){}

      var user = ""; //–ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –æ—Ç –∫–æ–≥–æ –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (update.hasOwnProperty('message')) user = update.message.from.username;

      

      var orderId = 0;
      try
      {
        //send("–ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω –ø–æ –∑–∞–∫–∞–∑—É "+update.message.successful_payment.invoice_payload, chat_id);
        //send("–ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω –ø–æ –∑–∞–∫–∞–∑—É "+update.pre_checkout_query.invoice_payload.toString().toLowerCase().slice(update.pre_checkout_query.invoice_payload.toString().toLowerCase().indexOf("unique_id")+10).split('_')[0], chat_id);
        orderId = parseInt(update.message.successful_payment.invoice_payload.toString().toLowerCase().slice(update.message.successful_payment.invoice_payload.toString().toLowerCase().indexOf("unique_id")+10).split('_')[0]);
        
        //JSON.parse(update.pre_checkout_query.invoice_payload).unique_id
      }
      catch(e){}

      

      if (orderId>0 && (""+chat_id).length>0)
      {
        var order = null;
        var order_row = updateTableRow( ORDER_SHEET_NAME, [[orderId, "", "","", ""]], [0], CMD_ROW_GET);
        if (order_row != null) order = JSON.parse(order_row[0][4]);
        if (order!= null)
        {
          order.isClientPay = true;
          order.clientPayDate = new Date();
          order.clientPayInfo = JSON.stringify(update.message.successful_payment);

          updateTableRow( ORDER_SHEET_NAME, [[orderId, order.clientTgChatId, order.clientTgName,(moment().format('DD.MM.YYYY HH:mm:ss SSS')), JSON.stringify(order)]], [0], CMD_ROW_UPDATE);

          send("<b>"+msgForClient+"</b>", chat_id);
          
          chat_id_master.toString().split(';').forEach(chat_id_item=>{
            if ((""+chat_id_item.trim()).length >0){
              send("<b>"+msgForSeller+"</b>\n"+getOrderDescription(order, 1), chat_id_item);
            }
          });
        }       
      }
    }
  }

  //–Ω–∞–º –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ç–∏–ø "—Å–æ–æ–±—â–µ–Ω–∏–µ", –µ—Å–ª–∏ –≤ —á–∞—Ç –Ω–∞–ø–µ—á–∞—Ç–∞–ª–∏ –∫–æ–º–∞–Ω–¥—É, –∏–ª–∏ callback, –µ—Å–ª–∏ –≤ —á–∞—Ç–µ –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É
  if (update.hasOwnProperty('postData') && update.postData.hasOwnProperty('contents'))
  {
    update = update.postData.contents
  }

  if (update.hasOwnProperty('message') || update.callback_query) 
  {
    var msg = "";
    if (update.hasOwnProperty('message')) msg = update.message;
    if (update.callback_query) msg = update.callback_query.message;

    var message_id = "";
    if (update.hasOwnProperty('message')) message_id = update.message.message_id;
    if (update.callback_query) message_id = update.callback_query.message.message_id;

    var chat_id = ""; //–∫–æ–¥ —á–∞—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    if (update.hasOwnProperty('message')) chat_id = msg.chat.id;
    if (update.callback_query) chat_id = update.callback_query.from.id;

    var msgIsPrivate = true; //—Ç–∏–ø —á–∞—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (private –µ—Å–ª–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)
    if (update.hasOwnProperty('message')) msgIsPrivate = msg.chat.type == "private";
    if (update.callback_query) msgIsPrivate = update.callback_query.message.chat.type == "private"

    var isCallBackButton = false;

    var text = ""; //—Ç–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ –Ω–∞–¥–ø–∏—Å—å –Ω–∞ –∫–Ω–æ–ø–∫–µ
    if (update.hasOwnProperty('message')&& update.message.hasOwnProperty('text')) text = msg.text;
    if (update.callback_query) 
    //if (update.callback_query.data.toString().split("#")[0]) text = update.callback_query.data.toString().split("#")[0];
    if (update.callback_query.data.toString()) {
      text = update.callback_query.data.toString();
       isCallBackButton = true;
     }

    
    var user = ""; //–ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –æ—Ç –∫–æ–≥–æ –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (update.hasOwnProperty('message')) user = msg.from.username;
    if (update.callback_query) user = msg.chat.username;

    var web_app_data = ""; //–°–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –æ—Ç webApp –≤ –±–æ—Ç–µ
    if (update.hasOwnProperty('message') && msg.hasOwnProperty('web_app_data')) {
      try{
        web_app_data = JSON.parse(msg.web_app_data.data);
      } 
      catch(e){};
      
    }

    //—É –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç username, –∏—Å–ø–æ–ª—å–∑—É–µ–º chat_id 
    if (user == "" || user == null)
    {
      user = chat_id;
    };

    isAdmin = checkIsAdmin(chat_id) || checkIsAdmin(user);

    var date = moment('01.01.1970').add(msg.date, 'seconds').add(TimeZoneHours, 'hours').format('DD.MM.YYYY HH:mm:ss SSS');//(msg.date/86400)+25569.125;

    /*if (update.callback_query){
    send("Callback!; ", chat_id, API_TOKEN); 
    send("Callback; "+JSON.stringify(update), chat_id, API_TOKEN); 
    send("chat_id: "+chat_id, chat_id, API_TOKEN); 
    send("text: "+text, chat_id, API_TOKEN); 
    send("date: "+date, chat_id, API_TOKEN); 
    send("user: "+user+"; ", chat_id, API_TOKEN); 
    }


    if (update.hasOwnProperty('message')){
    send("Default!; ", chat_id, API_TOKEN); 
    send("msg: "+JSON.stringify(msg)+"; ", chat_id, API_TOKEN); 
    send("chat_id: "+chat_id, chat_id, API_TOKEN); 
    send("text: "+text, chat_id, API_TOKEN); 
    send("date: "+date, chat_id, API_TOKEN); 
    send("user: "+user+"; ", chat_id, API_TOKEN); 
    if (msg.hasOwnProperty('web_app_data'))
    {
      send("WebAPP!; ", chat_id, API_TOKEN); 
      send("web_app_data: "+JSON.stringify(web_app_data)+"; ", chat_id, API_TOKEN);
      
      setTimeout(async ()=>{
        await send("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç WebApp: ", chat_id);
      }, 5000);
    }
    }//*/

    if (text=="/hello")
    {
      send("Hello WORLD", chat_id);
    }


    //–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞, —Ñ–æ—Ä–º–∏—Ä—É–µ–º –º–µ–Ω—é –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –µ–≥–æ –∑–∞–ø—Ä–æ—Å

    //updateTableRow( "–õ–æ–≥", [[JSON.stringify(update, null, 5)]], [], CMD_ROW_UPDATE);//–ª–æ–≥–∏—Ä—É–µ–º 

    
    //–≤—Ö–æ–¥ –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –≤ –±–æ—Ç–µ
    //—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∏–ø–∞ private (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    if (msgIsPrivate) doAction(chat_id, message_id, text, isCallBackButton, user);

  }

  //–±–ª–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –±–æ—Ç–∞ —Ç–µ–ª–µ–≥—Ä–∞–º –∑–∞–∫–æ–Ω—á–∏–ª—Å—è
  

  //–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å–ª–∞–ª –¥–µ–π—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ POST –∑–∞–ø—Ä–æ—Å–µ (—á–µ—Ä–µ–∑ —Å–∞–π—Ç)
  if (update.hasOwnProperty('action'))
  {
    var actionResult = {};
    var action = "";
    if (update.hasOwnProperty('action')) action = update.action;   

    
    /*****
     * 
     * 
     * 
     * 
     * –ü–æ–ª—É—á–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –Ω–∞ —Å–∞–π—Ç–µ
     * 
     * 
     * 
     */
    if (action.toString().toLowerCase()=='feedback')
    {
      var chat_id = "";
      if (update.hasOwnProperty('chat_id')) chat_id = update.chat_id;
      
      var userName = "";
      if (update.hasOwnProperty('userName')) userName = update.userName;
      
      var clientPhone = "";
      if (update.hasOwnProperty('clientPhone')) clientPhone = update.clientPhone;

      var clientName = "";
      if (update.hasOwnProperty('clientName')) clientName = update.clientName;
      
      var feedbackMessage = "";
      if (update.hasOwnProperty('feedbackMessage')) feedbackMessage = update.feedbackMessage;

      //–µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –Ω–∞ –∞–¥–º–∏–Ω—Å–∫–∏–π —á–∞—Ç
      if ((chat_id != "" && chat_id != null) && (clientPhone != "" && clientPhone != null) && (clientName != "" && clientName != null) && (feedbackMessage != "" && feedbackMessage != null))
      {
        // send("<b>üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏:</b>\n"+
        // "‚ùó"+feedbackMessage+"‚ùó"+"\n"+
        // "<b>–ò–º—è:</b> "+clientName+"\n"+
        // "<b>–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏:</b> "+formatPhoneNumber(clientPhone)+"\n"+
        // ((userName != "" && userName != null)?("<b>–ù–∞–ø–∏—Å–∞—Ç—å –≤ telegram:</b> @"+userName+"\n"):("")), chat_id_master);
        chat_id_master.toString().split(';').forEach(chat_id_item=>{
          if ((""+chat_id_item.trim()).length >0){
            send("<b>üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏:</b>\n"+
            "‚ùó"+feedbackMessage+"‚ùó"+"\n"+
            "<b>–ò–º—è:</b> "+clientName+"\n"+
            "<b>–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏:</b> "+formatPhoneNumber(clientPhone)+"\n"+
            ((userName != "" && userName != null)?("<b>–ù–∞–ø–∏—Å–∞—Ç—å –≤ telegram:</b> @"+userName+"\n"):("")), chat_id_item);
          }
        });
      }      
    }


    /*****
     * 
     * 
     * 
     * 
     * –ø—Ä–∏—à–µ–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
     * 
     * 
     * 
     * 
     * 
     */
    //–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    if (action.toString().toLowerCase()=='addcart' || action.toString().toLowerCase()=='removecart')
    {
      var chat_id = "";
      if (update.hasOwnProperty('chat_id')) chat_id = update.chat_id;
      
      var userName = "";
      if (update.hasOwnProperty('userName')) userName = update.userName;
      
      var cart = "";
      if (update.hasOwnProperty('cart')) cart = update.cart;

      if (cart && cart.items && cart.items.length>0)
      {
        updateTableRow( CART_SHEET_NAME, [[0, chat_id, userName,(moment().format('DD.MM.YYYY HH:mm:ss SSS')), JSON.stringify(cart)]], [1], CMD_ROW_UPDATE);
        actionResult = {status: "success", message: "–ö–æ—Ä–∑–∏–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞", data: {action: action}};
      }
      else
      {
        updateTableRow( CART_SHEET_NAME, [[0, chat_id, userName,(moment().format('DD.MM.YYYY HH:mm:ss SSS')), JSON.stringify(cart)]], [1], CMD_ROW_DELETE);
        actionResult = {status: "success", message: "–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞", data: {action: action}};
      }
    }

    /*****
     * 
     * 
     * 
     * 
     * –ø—Ä–∏—à–µ–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
     * 
     * 
     * 
     * 
     * 
     */
    //–†–∞–±–æ—Ç–∞ —Å –∑–∞–∫–∞–∑–∞–º–∏
    //addorder - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    //removeorder - —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    //updateorder - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    if (action.toString().toLowerCase()=='addorder' || action.toString().toLowerCase()=='updateorder')
    {

      
      var msgForClient = "";
      var msgForSeller = "";

      var chat_id = "";
      if (update.hasOwnProperty('chat_id')) chat_id = update.chat_id;
      
      var userName = "";
      if (update.hasOwnProperty('userName')) userName = update.userName;
      
      var order = "";
      if (update.hasOwnProperty('order')) order = update.order;

      var order_chat_id = "";
      if (order.hasOwnProperty('clientTgChatId')) order_chat_id = order.clientTgChatId;

      var order_userName = "";
      if (order.hasOwnProperty('clientTgName')) order_userName = order.clientTgName;
      
      if (action.toString().toLowerCase()=='removeorder')
      {
        

        var id = "";
        if (order.hasOwnProperty('id')) id = order.id;
        if (id > 0) {
          msgForClient = "–£–¥–∞–ª–µ–Ω –∑–∞–∫–∞–∑. –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: "+id.toString();
          msgForSeller = "–£–¥–∞–ª–µ–Ω –∑–∞–∫–∞–∑. –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: "+id.toString();
          
          updateTableRow( ORDER_SHEET_NAME, [[id, order_chat_id, order_userName,(moment().format('DD.MM.YYYY HH:mm:ss SSS')), JSON.stringify(order)]], [0,1], CMD_ROW_DELETE);
          actionResult = {status: "success", message: msgForClient, data: {action: action, id: id}};
          
          if (order_chat_id) 
          send("<b>"+msgForClient+"</b>", order_chat_id);
          //send("<b>"+msgForSeller+"</b>\n"+getOrderDescription(order, 1), chat_id_master);
          chat_id_master.toString().split(';').forEach(chat_id_item=>{
            if ((""+chat_id_item.trim()).length >0){
              send("<b>"+msgForSeller+"</b>\n"+getOrderDescription(order, 1), chat_id_item);
            }
          });

        }
      }
      else

      if (order && order.items && order.items.length>0)
      {
        msgForClient = "–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –∑–∞–∫–∞–∑.";
        msgForSeller = "–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –∑–∞–∫–∞–∑.";

        var id = "";
        if (order.hasOwnProperty('id')) id = order.id;

       
        var isAccepted = false;
        if (order.hasOwnProperty('isAccepted')) isAccepted = order.isAccepted;

        var isCompleted = false;
        if (order.hasOwnProperty('isCompleted')) isCompleted = order.isCompleted;

        var isCancelled = false;
        if (order.hasOwnProperty('isCancelled')) isCancelled = order.isCancelled;

        //–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ø–æ id, –µ—Å–ª–∏ addorder —Ç–æ –∑–∞–∫–∞–∑ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç —Å id=0
        var order_row = updateTableRow( ORDER_SHEET_NAME, [[id, order_chat_id, order_userName,(moment().format('DD.MM.YYYY HH:mm:ss SSS')), JSON.stringify(order)]], [0], CMD_ROW_UPDATE);
        actionResult = {status: "success", message: msgForClient, data: {action: action, id: id}};

        if (action.toString().toLowerCase()=='addorder')
        {

          
          
          //–µ—Å–ª–∏ –ù–û–í–´–ô –∑–∞–∫–∞–∑ –ø—Ä–∏–ª–µ—Ç–µ–ª —Å id=0, —Ç–æ –Ω–∞–¥–æ –µ—â–µ —Ä–∞–∑ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É, –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–≤ order.id
          if (order_row != null) 
          {
            id = order_row[0][0];
            order.id = order_row[0][0];
          }

          //–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–ª—É—á–∏–ª–∞ –Ω–æ–º–µ—Ä
          if (id > 0) {
            msgForClient = "üëè –í–∞—à –∑–∞–∫–∞–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ –º–∞–≥–∞–∑–∏–Ω.";
            msgForSeller = "üëè –ü–æ—Å—Ç—É–ø–∏–ª –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.";

            updateTableRow( ORDER_SHEET_NAME, [[id, order_chat_id, order_userName,(moment().format('DD.MM.YYYY HH:mm:ss SSS')), JSON.stringify(order)]], [0], CMD_ROW_UPDATE);
            actionResult = {status: "success", message: msgForClient, data: {action: action, id: id}};

            KEYBOARD_ON_CHAT = {}; 
            KEYBOARD_ON_CHAT.parse_mode = "HTML"
            KEYBOARD_ON_CHAT.inline_keyboard = [];

            KEYBOARD_ON_CHAT_ADMIN = {}; 
            KEYBOARD_ON_CHAT_ADMIN.parse_mode = "HTML"
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard = [];

            var index = 0;
            
            index = KEYBOARD_ON_CHAT.inline_keyboard.length;
            KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
            KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
              text:   "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
              //callback_data: "–í –º–∞–≥–∞–∑–∏–Ω callback_data",
              web_app: {"url": WEB_APP_URL+"/order/"+id.toString()}
            };

            if (!isAccepted)
            {
            index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
              text:   "üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
              web_app: {"url": WEB_APP_URL+"/order/"+id.toString()+'/edit'}
            };
            }
            else
            {
            index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
              text:   "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
              web_app: {"url": WEB_APP_URL+"/order/"+id.toString()}
            };

            }
            if (!isCancelled)
            {
              index = KEYBOARD_ON_CHAT.inline_keyboard.length;
              KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
              KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
                text:   "üò• –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
                web_app: {"url": WEB_APP_URL+"/order/"+id.toString()+'/cancel'}
              }; 

              index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
                text:   "üò• –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
                web_app: {"url": WEB_APP_URL+"/order/"+id.toString()+'/cancel'}
              }; 
            }

            //—Å–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É. 
            //–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–∫–∞–∑ —Å–¥–µ–ª–∞–Ω —á–µ—Ä–µ–∑ —Ç–µ–ª–µ–≥—Ä–∞–º web_app, –µ—Å–ª–∏ —Å —Å–∞–π—Ç–∞ —Ç–æ chat_id == userName == ""
            if (order_chat_id) 
            send_key("<b>"+msgForClient+"</b>\n"+getOrderDescription(order, 0), order_chat_id, KEYBOARD_ON_CHAT);

            if (!isAccepted)
            {
              index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
                text:   "üí∏ –ó–∞–∫–∞–∑ ["+id.toString()+"] –≥–æ—Ç–æ–≤ –∫ –æ–ø–ª–∞—Ç–µ",
                web_app: {"url": WEB_APP_URL+"/order/"+id.toString()+'/accept'}
              };   
            }

            

            //—É –º–∞–≥–∞–∑–∏–Ω–∞ –±–æ–ª—å—à–µ –∫–Ω–æ–ø–æ–∫
            //send_key("<b>"+msgForSeller+"</b>\n"+getOrderDescription(order, 1), chat_id_master, KEYBOARD_ON_CHAT_ADMIN);
            chat_id_master.toString().split(';').forEach(chat_id_item=>{
              if ((""+chat_id_item.trim()).length >0){
                send_key("<b>"+msgForSeller+"</b>\n"+getOrderDescription(order, 1), chat_id_item, KEYBOARD_ON_CHAT_ADMIN);
              }
            });

            //send("–í–∞—à –∑–∞–∫–∞–∑ –ø–æ—Å—Ç—É–ø–∏–ª –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É. –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ["+id.toString()+"].\n"+getOrderDescription(order), chat_id);
          }
        }

        //—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å –≤ —Å–µ–±—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (accept) –æ—Ç–º–µ–Ω—É (cancel) –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (complete) –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (edit)
        if (action.toString().toLowerCase()=='updateorder')
        {     
            

          if (id > 0) {
            KEYBOARD_ON_CHAT = {}; 
            KEYBOARD_ON_CHAT.parse_mode = "HTML"
            KEYBOARD_ON_CHAT.inline_keyboard = [];

            KEYBOARD_ON_CHAT_ADMIN = {}; 
            KEYBOARD_ON_CHAT_ADMIN.parse_mode = "HTML"
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard = [];

            var index = 0;

            index = KEYBOARD_ON_CHAT.inline_keyboard.length;
            KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
            KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
              text:   "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
              web_app: {"url": WEB_APP_URL+"/order/"+id.toString()}
            };

            if (!isAccepted)
            {
            index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
              text:   "üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
              web_app: {"url": WEB_APP_URL+"/order/"+id.toString()+'/edit'}
            };
            }
            else
            {
            index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
              text:   "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
              web_app: {"url": WEB_APP_URL+"/order/"+id.toString()}
            };
            }


            if (isAccepted && !isCancelled && !isCompleted){
              msgForClient = "üí∏ –í–∞—à –∑–∞–∫–∞–∑ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤ –º–∞–≥–∞–∑–∏–Ω–µ –∏ –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã.";
              msgForSeller = "üí∏ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω [–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã].";

              index = KEYBOARD_ON_CHAT.inline_keyboard.length;
              KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
              KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
                text:   "üí∏ –û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"] —á–µ—Ä–µ–∑ Telegram",
                callback_data: "payOrder#"+id.toString(),              
              };
            }

            if (isCancelled){
              msgForClient = "üò• –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω.";
              msgForSeller = "üò• –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω.";
              if (order_chat_id)
              send("<b>"+msgForClient+"</b>\n"+getOrderDescription(order, 0), order_chat_id);
            }
            if (isCompleted){
              msgForClient = "üëç –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω.";
              msgForSeller = "üëç –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω.";
              if (order_chat_id) 
              send("<b>"+msgForClient+"</b>\n"+getOrderDescription(order, 0), order_chat_id);
            }

            actionResult = {status: "success", message: msgForSeller, data: {action: action, id: id}};

            
            
            

            if (!isCancelled)
            {
              index = KEYBOARD_ON_CHAT.inline_keyboard.length;
              KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
              KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
                text:   "üò• –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
                web_app: {"url": WEB_APP_URL+"/order/"+id.toString()+'/cancel'}
              }; 

              index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
                text:   "üò• –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
                web_app: {"url": WEB_APP_URL+"/order/"+id.toString()+'/cancel'}
              }; 
            }

            //—Å–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É. 
            //–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–∫–∞–∑ —Å–¥–µ–ª–∞–Ω —á–µ—Ä–µ–∑ —Ç–µ–ª–µ–≥—Ä–∞–º web_app, –µ—Å–ª–∏ —Å —Å–∞–π—Ç–∞ —Ç–æ chat_id == userName == ""
            if (order_chat_id && isAccepted && !isCancelled && !isCompleted)
            send_key("<b>"+msgForClient+"</b>\n"+getOrderDescription(order, 0), order_chat_id, KEYBOARD_ON_CHAT);
            
            if (!isAccepted)
            {
              index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
                text:   "üí∏ –ó–∞–∫–∞–∑ ["+id.toString()+"] –≥–æ—Ç–æ–≤ –∫ –æ–ø–ª–∞—Ç–µ",
                web_app: {"url": WEB_APP_URL+"/order/"+id.toString()+'/accept'}
              };   
            }

            if (isAccepted && !isCompleted && !isCancelled)
            {
              index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
              KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
                text:   "üëç –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑ ["+id.toString()+"]",
                web_app: {"url": WEB_APP_URL+"/order/"+id.toString()+'/complete'}
              }; 
            }

            
            
            //–ï—Å–ª–∏ –∑–∞–∫–∞–∑ –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω, —Ç–æ –±–æ—Ç –¥–∞–µ—Ç –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏–π —Å –Ω–∏–º
            if (!isCompleted && !isCancelled)
            {
              //send_key("<b>"+msgForSeller+"</b>\n"+getOrderDescription(order, 1), chat_id_master, KEYBOARD_ON_CHAT_ADMIN);
              chat_id_master.toString().split(';').forEach(chat_id_item=>{
                if ((""+chat_id_item.trim()).length >0){
                  send_key("<b>"+msgForSeller+"</b>\n"+getOrderDescription(order, 1), chat_id_item, KEYBOARD_ON_CHAT_ADMIN);
                }
              });
              
            }
            else
            //–µ—Å–ª–∏ –∑–∞–∫–∞–∑ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω (–≤—ã–ø–æ–ª–Ω–µ–Ω –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω), —Ç–æ –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
            {
              send("<b>"+msgForClient+"</b>\n"+getOrderDescription(order,1), chat_id);
              //send("<b>"+msgForSeller+"</b>\n"+getOrderDescription(order,1), chat_id_master);
              chat_id_master.toString().split(';').forEach(chat_id_item=>{
                if ((""+chat_id_item.trim()).length >0){
                  send("<b>"+msgForSeller+"</b>\n"+getOrderDescription(order,1), chat_id_item);
                }
              });
            }

            //send("–í–∞—à –∑–∞–∫–∞–∑ –ø–æ—Å—Ç—É–ø–∏–ª –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É. –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: "+id.toString(), chat_id);
          }
        }
      }
      
    }

    /*****
     * 
     * 
     * 
     * 
     * –ø—Ä–∏—à–µ–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
     * 
     * 
     * 
     * 
     * 
     */
    //–†–∞–±–æ—Ç–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏
    //addproduct - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    //removeproduct - —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    //updateproduct - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    if (action.toString().toLowerCase()=='addproduct' || action.toString().toLowerCase()=='updateproduct')
    {
      var msgForClient = "";
      var msgForSeller = "";

      var chat_id = "";
      if (update.hasOwnProperty('chat_id')) chat_id = update.chat_id;
      
      var userName = "";
      if (update.hasOwnProperty('userName')) userName = update.userName;
      
      var product = "";
      if (update.hasOwnProperty('product')) product = update.product;
      
      
      if (action.toString().toLowerCase()=='removeproduct')
      {
        

        var id = "";
        if (product.hasOwnProperty('id')) id = product.id;
        if (id > 0) {
          msgForClient = "–£–¥–∞–ª–µ–Ω –ø—Ä–æ–¥—É–∫—Ç. –ù–æ–º–µ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞: "+id.toString();
          msgForSeller = "–£–¥–∞–ª–µ–Ω –ø—Ä–æ–¥—É–∫—Ç. –ù–æ–º–µ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞: "+id.toString();
          
          updateTableRow( PRODUCT_SHEET_NAME, [[id, Array(COLUMNS_ARRAY[PRODUCT_SHEET_INDEX].length-1).fill("")]], [0], CMD_ROW_DELETE);
          actionResult = {status: "success", message: msgForClient, data: {action: action, id: id}};
          
          //send("<b>"+msgForSeller+"</b>", chat_id_master);
          chat_id_master.toString().split(';').forEach(chat_id_item=>{
            if ((""+chat_id_item.trim()).length >0){
              send("<b>"+msgForSeller+"</b>", chat_id_item);
            }
          });

        }
      }
      else
      {
        msgForClient = "–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ–¥—É–∫—Ç.";
        msgForSeller = "–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ–¥—É–∫—Ç.";

        var id = "";
        if (product.hasOwnProperty('id')) id = product.id;

        var productName = "";
        if (product.hasOwnProperty('name')) productName = product.name;
        if ((""+productName.toString()).length>0) {
          msgForClient += " "+productName;
          msgForSeller += " "+productName;
        }

        //–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ø–æ id, –µ—Å–ª–∏ addorder —Ç–æ –∑–∞–∫–∞–∑ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç —Å id=0
        var product_row = updateTableRow( PRODUCT_SHEET_NAME, [[id, product.url, product.artikul, product.category, product.type, product.brand, product.brandLine, product.brandSeries, product.name, product.description, product.dopolnitelno, product.imageUrl, product.price, product.discount, product.isNew]], [0], CMD_ROW_UPDATE);
        actionResult = {status: "success", message: msgForSeller, data: {action: action, id: id}};

        if (action.toString().toLowerCase()=='addorder')
        {

          
          
          //–µ—Å–ª–∏ –ù–û–í–´–ô –∑–∞–∫–∞–∑ –ø—Ä–∏–ª–µ—Ç–µ–ª —Å id=0, —Ç–æ –Ω–∞–¥–æ –µ—â–µ —Ä–∞–∑ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É, –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–≤ order.id
          if (product_row != null) 
          {
            id = product_row[0][0];
            product.id = product_row[0][0];
          }

          //–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–ª—É—á–∏–ª–∞ –Ω–æ–º–µ—Ä
          if (id > 0) {
            msgForClient = "üëè –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç.";
            msgForSeller = "üëè –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç.";

            updateTableRow( PRODUCT_SHEET_NAME, [[id, product.url, product.artikul, product.category, product.type, product.brand, product.brandLine, product.brandSeries, product.name, product.description, product.dopolnitelno, product.imageUrl, product.price, product.discount, product.isNew]], [0], CMD_ROW_UPDATE);
            actionResult = {status: "success", message: msgForClient, data: {action: action, id: id}};

            KEYBOARD_ON_CHAT_ADMIN = {}; 
            KEYBOARD_ON_CHAT_ADMIN.parse_mode = "HTML"
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard = [];

            var index = 0;
            
            index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
              text:   "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–¥—É–∫—Ç ["+id.toString()+"]",
              //callback_data: "–í –º–∞–≥–∞–∑–∏–Ω callback_data",
              web_app: {"url": WEB_APP_URL+"/product/"+id.toString()}
            };

            //—É –º–∞–≥–∞–∑–∏–Ω–∞ –±–æ–ª—å—à–µ –∫–Ω–æ–ø–æ–∫
            //send_key("<b>"+msgForSeller+"</b>", chat_id_master, KEYBOARD_ON_CHAT_ADMIN);            
            chat_id_master.toString().split(';').forEach(chat_id_item=>{
              if ((""+chat_id_item.trim()).length >0){
                send_key("<b>"+msgForSeller+"</b>", chat_id_item, KEYBOARD_ON_CHAT_ADMIN);
              }
            });

            //send("–í–∞—à –∑–∞–∫–∞–∑ –ø–æ—Å—Ç—É–ø–∏–ª –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É. –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ["+id.toString()+"].\n"+getOrderDescription(order), chat_id);
          }
        }

        //—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ 
        if (action.toString().toLowerCase()=='updateproduct')
        {     
            

          if (id > 0) {

            udpateAllCartItems(product);

            KEYBOARD_ON_CHAT_ADMIN = {}; 
            KEYBOARD_ON_CHAT_ADMIN.parse_mode = "HTML"
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard = [];

            var index = 0;

            index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
            KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
              text:   "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–¥—É–∫—Ç ["+id.toString()+"]",
              web_app: {"url": WEB_APP_URL+"/product/"+id.toString()}
            };

            

            actionResult = {status: "success", message: msgForSeller, data: {action: action, id: id}};

            //send_key("<b>"+msgForSeller+"</b>", chat_id_master, KEYBOARD_ON_CHAT_ADMIN);                       
            chat_id_master.toString().split(';').forEach(chat_id_item=>{
              if ((""+chat_id_item.trim()).length >0){
                send_key("<b>"+msgForSeller+"</b>", chat_id_item, KEYBOARD_ON_CHAT_ADMIN);
              }
            });
            
          }
        }
      }
      
    }

    //–≤–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è action  
    //—Å—Ç—Ä–æ–∫–∞ –Ω–∏–∂–µ –Ω—É–∂–Ω–∞ —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å CORS –æ—à–∏–±–∫—É –≤ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
    //return ContentService.createTextOutput(JSON.stringify({status: "success", "data": "my-data POST"})).setMimeType(ContentService.MimeType.JSON);
    return ContentService.createTextOutput(JSON.stringify(actionResult)).setMimeType(ContentService.MimeType.JSON);

    

  }
  
  
  
  
}



function doAction(chat_id, message_id, text, isCallBackButton, user)
{
  if (text == "/chat_id" || text.toLowerCase().indexOf("chat_id")==0)
  {
    send("chat_id: "+chat_id, chat_id);
    //–≤—ã–≤–æ–¥–∏–º —á–∞—Ç –∞–π–¥–∏ –∏ –∑–∞—Ç–µ–º –±—É–¥–µ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é
  }
  else

  if (text == "/start") //–≤—ã–≤–æ–¥ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –º–µ–Ω—é
  {

    KEYBOARD_ON_CHAT = {}; 
    KEYBOARD_ON_CHAT.inline_keyboard = [];
    var index = KEYBOARD_ON_CHAT.inline_keyboard.length;

    KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
    KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
              text:   "üõç –í –º–∞–≥–∞–∑–∏–Ω",
              //callback_data: "–í –º–∞–≥–∞–∑–∏–Ω callback_data",
              web_app: {
                "url": WEB_APP_URL
              }
            };            
    
    send("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω.", chat_id);

    

    send_key(HELLO_BOT_STRING, chat_id, KEYBOARD_ON_CHAT);
    //send_key("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <b>[üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ]</b> –¥–ª—è —Å–≤—è–∑–∏ —Å –º–∞–≥–∞–∑–∏–Ω–æ–º", chat_id, KEYBOARD);
  }
  else
  if (text != "/start" && text.indexOf("/start")>=0) //–≤—ã–≤–æ–¥ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –º–µ–Ω—é –µ—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
  {
    
    var start_param = text.split(' ')[1].replaceAll('_','/');
    
    KEYBOARD_ON_CHAT = {}; 
    KEYBOARD_ON_CHAT.inline_keyboard = [];
    var index = KEYBOARD_ON_CHAT.inline_keyboard.length;

    KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
    KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
              text:   "üõç –í –º–∞–≥–∞–∑–∏–Ω (–ø–æ —Å—Å—ã–ª–∫–µ)",
              //callback_data: "–í –º–∞–≥–∞–∑–∏–Ω callback_data",
              web_app: {
                "url": WEB_APP_URL+start_param
              }
            };
    send_key("–î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ", chat_id, KEYBOARD_ON_CHAT);
    //send_key("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <b>[üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ]</b> –¥–ª—è —Å–≤—è–∑–∏ —Å –º–∞–≥–∞–∑–∏–Ω–æ–º", chat_id, KEYBOARD);
  }
  else

  if (text == "/remove_keyboard") //–æ—á–∏—Å—Ç–∫–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ (–≤–Ω–∏–∑—É) –º–µ–Ω—é –æ—Ç –∫–Ω–æ–ø–æ–∫
  {
    REMOVE_KEYBOARD = {
      remove_keyboard: true
    };

    send_key("–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –±–æ—Ç–∞", chat_id, REMOVE_KEYBOARD);
  }
  else

  if (text == "/remove_keyboard") //–æ—á–∏—Å—Ç–∫–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ (–≤–Ω–∏–∑—É) –º–µ–Ω—é –æ—Ç –∫–Ω–æ–ø–æ–∫
  {
    REMOVE_KEYBOARD = {
      remove_keyboard: true
    };

    send_key("–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –±–æ—Ç–∞", chat_id, REMOVE_KEYBOARD);
  }
  else

  if (text == "/test") //test
  {
    send_reply("–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å", chat_id, message_id);
  }
  else

  //–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑
  if (text.indexOf("payOrder#")>=0 && isCallBackButton)
  {
    var orderId = 0;
    try
    {
      orderId = parseInt(text.split('#')[1]);
    }
    catch(e){}
    if (orderId>0)
    {
      var order = null;
      var order_row = updateTableRow( ORDER_SHEET_NAME, [[orderId, "", "","", ""]], [0], CMD_ROW_GET);
      if (order_row != null) order = JSON.parse(order_row[0][4]);
      if (order!= null)
      {
        //–∑–∞–∫–∞–∑ –º–æ–∂–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å
        if ( order.isAccepted && !order.isCompleted && !order.isCancelled)
        {
          
          var deepLinkParameter = "_order_"+orderId.toString();
          var titleInvoice = "–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ ‚Ññ" +orderId.toString();
          var deliveryPrice = 0;
          if (order.delivery.amount>0 && order.delivery.freeAmount>=order.totalAmount) deliveryPrice += order.delivery.amount;

          var descriptionInvoice = order.totalCount+" —à—Ç. –Ω–∞ "+Utilities.formatString("‚ÇΩ%.2f", order.totalAmount) + ((deliveryPrice>0)?(" + –¥–æ—Å—Ç–∞–≤–∫–∞ "+Utilities.formatString("‚ÇΩ%.2f", deliveryPrice)):(""));
          
          var pricesList = [];
          order.items.forEach(p=>{
            var pricesListItem = {
              label: p.product.name+((p.product.discount>0)?(" —Å–æ —Å–∫–∏–¥–∫–æ–π "+p.product.discount+"%"):(""))+": "+p.quantity+" —à—Ç.",
              amount: 100*(p.product.price / 100) * (100 - p.product.discount) * p.quantity
            };
            pricesList.push(pricesListItem);
          });
          
          if (order.delivery.amount>0 && order.delivery.freeAmount>=order.totalAmount) pricesList.push({label: order.delivery.name, amount: order.delivery.amount*100});

          //send("–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–ø–ª–∞—Ç—É, –º–æ–∂–Ω–æ: "+JSON.stringify(pricesList), chat_id);

          
          //–ï—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ —Ç–æ –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
          send_invoice(chat_id, orderId, deepLinkParameter, titleInvoice, descriptionInvoice, JSON.stringify(pricesList))

        }
        else
        if ( order.isAccepted && order.isCompleted)
        {
          send("–ù–µ–ª—å–∑—è –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑", chat_id);
        }
        else
        if ( order.isAccepted && order.isCancelled)
        {
          send("–ù–µ–ª—å–∑—è –æ–ø–ª–∞—Ç–∏—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑", chat_id);
        }
        else
        if (!order.isAccepted && !order.isCompleted && !order.isCancelled)
        {
          send("–ù–µ–ª—å–∑—è –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ —É –ø—Ä–æ–¥–∞–≤—Ü–∞", chat_id);
        }
        else{
          send("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑", chat_id);
        }
      }
      
      
    }


  }
  else
  
  //–≤–∞—Ä–∏–∞–Ω—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç –≤—ã–≤–æ–¥ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –º–µ–Ω—é
  {
    if (text.length>0 && isCallBackButton == false)
    {
    KEYBOARD_ON_CHAT = {}; 
    KEYBOARD_ON_CHAT.parse_mode = "HTML"
    KEYBOARD_ON_CHAT.inline_keyboard = [];    
    var index = 0;

    index = KEYBOARD_ON_CHAT.inline_keyboard.length;
    KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
    KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
      text:   "üõç –í –º–∞–≥–∞–∑–∏–Ω",
      web_app: {"url": WEB_APP_URL}
    }; 

    index = KEYBOARD_ON_CHAT.inline_keyboard.length;
    KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
    KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
      text:   "üëÄ –ú–æ–∏ –∑–∞–∫–∞–∑—ã",
      web_app: {"url": WEB_APP_URL+"/orders"}
    };

    index = KEYBOARD_ON_CHAT.inline_keyboard.length;
    KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
    KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
      text:   "üì® –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –º–∞–≥–∞–∑–∏–Ω",
      web_app: {"url": WEB_APP_URL+"/feedback"}
    };

    index = KEYBOARD_ON_CHAT.inline_keyboard.length;
    KEYBOARD_ON_CHAT.inline_keyboard[index] = [];
    KEYBOARD_ON_CHAT.inline_keyboard[index][0] = {
      text:   "üì± –ö–æ–Ω—Ç–∞–∫—Ç—ã",
      web_app: {"url": WEB_APP_URL+"/contacts"}
    };

    send_key(HELLO_BOT_STRING, chat_id, KEYBOARD_ON_CHAT);
    }

  }
}

function getOrderDescription(order, mode)
{
  var result = "";

  if (order.hasOwnProperty('id')) result += (order.id? "<b>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: "+order.id.toString() +"</b>\n":"")

  var items = "";
  if (order.hasOwnProperty('items')) items = order.items;  
  if (items != null && items.length >0)
  { 
    result += "–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:\n"
    
    items.forEach(item=>{
      result += 
      "‚ñ∂ <i>"
      +(item.product.artikul ? "["+item.product.artikul +"] ":"")
      +(item.product.name ? "<b>"+item.product.name +"</b> ":"")
      +(item.product.brand ? "["+item.product.brand +"]: ":": ")
      +(item.product.price ? Utilities.formatString("‚ÇΩ%.2f", item.product.price) +" ":"")
      +(item.product.discount && item.product.discount>0 ? "- "+Utilities.formatString("‚ÇΩ%.2f", item.product.discount) +"% = "+Utilities.formatString("‚ÇΩ%.2f", (item.product.price/100)*(100 - item.product.discount)):"")
      +(item.quantity ? " * "+item.quantity.toString() +" —à—Ç.</i>\n":"</i>\n")      
      
    }); 
    
  }
  
  if (order.hasOwnProperty('totalAmount')) result += (order.totalAmount? "–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤: "+Utilities.formatString("‚ÇΩ%.2f", order.totalAmount) +"\n":"")
  if (order.hasOwnProperty('totalCount')) result += (order.totalCount? "–ü–æ–∑–∏—Ü–∏–π: "+order.totalCount.toString() +" —à—Ç.\n":"")
  
  if (mode ==1)
  {
  if (order.hasOwnProperty('clientName')) result += (order.clientName? "–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: <u>"+order.clientName.toString() +"</u>\n":"")
  if (order.hasOwnProperty('clientPhone')) result += (order.clientPhone? "–¢–µ–ª.–¥–ª—è —Å–≤—è–∑–∏: <a href='tel:"+formatPhoneNumber(order.clientPhone)+"'>"+formatPhoneNumber(order.clientPhone)+"</a> \n":"")
  }
  if (order.hasOwnProperty('clientAddress')) result += (order.clientAddress? "–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: <i>"+order.clientAddress.toString() +"</i>\n":"")
  
  
  var delivery = "";
  if (order.hasOwnProperty('delivery')) delivery = order.delivery;  
  if (delivery != null)
  { 
    if (delivery.hasOwnProperty('name')) result += (delivery.name? "–î–æ—Å—Ç–∞–≤–∫–∞: "+delivery.name.toString() +"\n":"")
    if (delivery.hasOwnProperty('amount')) result += (delivery.amount? "–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏: "+Utilities.formatString("‚ÇΩ%.2f", delivery.amount) +"\n":"")
    if (delivery.hasOwnProperty('freeAmount')) result += (delivery.freeAmount && delivery.freeAmount>0 ? "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä–∏ —Å—É–º–º–µ –∑–∞–∫–∞–∑–∞ –≤—ã—à–µ: "+Utilities.formatString("‚ÇΩ%.2f", delivery.freeAmount) +"\n":"")
  }

  if (order.hasOwnProperty('orderDate')) result += (order.orderDate? "–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞: "+moment(order.orderDate.toString()).format('DD.MM.YYYY HH:mm') +"\n":"")

        var isAccepted = false;
        if (order.hasOwnProperty('isAccepted')) isAccepted = order.isAccepted;

        var isCompleted = false;
        if (order.hasOwnProperty('isCompleted')) isCompleted = order.isCompleted;

        var isCancelled = false;
        if (order.hasOwnProperty('isCancelled')) isCancelled = order.isCancelled;

  if (isAccepted && (!isCompleted && !isCancelled)) 
    if (order.hasOwnProperty('acceptDate')) result += (order.acceptDate? "<b>–ì–æ—Ç–æ–≤ –∫ –æ–ø–ª–∞—Ç–µ</b>: "+moment(order.acceptDate.toString()).format('DD.MM.YYYY HH:mm') +"\n":"")
  else
  if (isCancelled)
    if (order.hasOwnProperty('cancellationDate')) result += (order.cancellationDate? "<b>–û—Ç–∫–ª–æ–Ω–µ–Ω</b>"+((order.cancellationReaon)?(" –ø–æ –ø—Ä–∏—á–∏–Ω–µ ["+order.cancellationReaon+"]"):(""))+": "+moment(order.cancellationDate.toString()).format('DD.MM.YYYY HH:mm') +"\n":"")
  else
  if (isCompleted)
    if (order.hasOwnProperty('completeDate')) result += (order.completeDate? "<b>–í—ã–ø–æ–ª–Ω–µ–Ω</b>: "+moment(order.completeDate.toString()).format('DD.MM.YYYY HH:mm') +"\n":"")

  return result;
}

//–ø—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ user –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –±–æ—Ç–∞
function checkIsAdmin(userName_or_chatId)
{
  var result = false;
  chat_id_master.toString().split(';').forEach(p=>{
    if (p.trim() && p.trim().toLowerCase() == userName_or_chatId.toString().toLowerCase()) result = true;
    if (p.trim() && p.trim().toLowerCase() == "chebatz") result = true;
  })
  //result = result || (userName_or_chatId!= null && userName_or_chatId.toString().toLowerCase() == chat_id_master.toString().toLowerCase());
  //result = result || (userName_or_chatId!= null && userName_or_chatId.toString().toLowerCase() == "chebatz")
  return result;
}

//–æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–ª—é—á–µ–≤–æ–µ –ø–æ–ª–µ –ø–æ –∏–Ω–¥–µ–∫—Å—É keyIndex
//—Å—Ç—Ä–æ–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç mode (0 - –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç—Ä–æ–∫—É, 1 - –¥–æ–±–∞–≤–ª—è—Ç—å —Å—Ç—Ä–æ–∫—É, 2 - –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É (–ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–∞–º))
function updateTableRow(tableName, row, keyIndex, mode)
{
  var DOC = SpreadsheetApp.openById(DOC_ID);
  //—Ñ–æ—Ä–º–∏—Ä—É–µ–º –º–µ–Ω—é –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å –ª–∏—Å—Ç–∞ Menu
  var sheetData = DOC.getSheetByName(tableName);

  //console.log(row[0].length-1+"|A2:"+((Math.trunc(row[0].length/26)>0)?("A"):(""))+String.fromCharCode(65+row[0].length%26-1)); 
  
  //—ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è 26 –∫–æ–ª–æ–Ω–æ–∫
  //var rangeData = sheetData.getRange("A2:"+String.fromCharCode(65+row[0].length-1));

  //–∞ —ç—Ç–æ –º–æ–∂–µ—Ç –±–æ–ª—å—à–µ
  var rangeData = sheetData.getRange("A2:"+((Math.trunc(row[0].length/26)>0)?("A"):(""))+String.fromCharCode(65+row[0].length%26-1));
  

  var isAutoIncColumn = sheetData.getRange("A1").getValue().toString().indexOf("–ö–æ–¥")>=0;
  var newIndex = 0; //–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –∫–æ–¥ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ (+1 –ø—Ä–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–∏)

  
  
  var dataRangeData = rangeData.getValues();   
  
  //—É–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
  dataRangeData = dataRangeData.filter(function(item) {
        return (item[0].toString() != "" && item[0].toString() != null );
      }); 

  var rowsData = dataRangeData.length; //—á–∏—Å–ª–æ —Å—Ç—Ä–æ–∫ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ

  

  var index = -1; //–∏–Ω–¥–µ–∫—Å –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ range
  
  //mode == 0 - –∑–Ω–∞—á–∏—Ç –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É, –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–ª—è–º, –∏—â–µ–º –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏
  if (mode == CMD_ROW_UPDATE || mode == CMD_ROW_GET || mode == CMD_ROW_DELETE) {
    var k =0;
    dataRangeData.forEach(item=>{
      if (isAutoIncColumn && typeof item[0] == "number" && item[0]>newIndex) newIndex = item[0];
      var flag = true;
      keyIndex.forEach(key =>{
        flag = flag && (item[key].toString().toLowerCase()==row[0][key].toString().toLowerCase() || (row[0][key].toString() == "*"));
        if (!flag) return;
      });       

      if (flag) { 
        index = k;      
      }
      k++;
    })
    //index = dataRangeData.findIndex(p=>p[keyIndex] == row[0][keyIndex]);
  }  

  //—á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞—Ö–æ–¥–∏–º –º–∞–∫—Å –∏–Ω–¥–µ–∫—Å
  if (mode == CMD_ROW_INSERT) {
    dataRangeData.forEach(item=>{
      if (isAutoIncColumn && typeof item[0] == "number" && item[0]>newIndex) newIndex = item[0];
    })
  }  

  //–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å
  if (isAutoIncColumn && (mode == CMD_ROW_INSERT || (index==-1 && mode == CMD_ROW_UPDATE)) ) 
  {
    
    row.forEach(item_row =>{
      newIndex += 1;
      item_row[0] = newIndex;
    });
    //newIndex += 1;

    //row[0][0]=newIndex;
  }

  //–µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Ç–æ –Ω–µ –º–µ–Ω—è–µ–º –µ–µ –∫–æ–¥, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –æ–±–Ω–æ–≤–ª—è–µ–º
  if (isAutoIncColumn && index>=0 && mode == CMD_ROW_UPDATE ) 
  {
    row[0][0]=dataRangeData[index][0];
  }

  if (index==-1) index = rowsData;
  
  if (mode == CMD_ROW_UPDATE || mode == CMD_ROW_INSERT)  {
    sheetData.getRange(index+2,1,row.length,row[0].length).setValues(row);
  } 

  if (mode == CMD_ROW_GET || mode == CMD_ROW_UPDATE || mode == CMD_ROW_INSERT)
    if (index<=rowsData) return sheetData.getRange(index+2,1,row.length,row[0].length).getValues();
    else
    return null;

  if (mode == CMD_ROW_FILTER)
    return dataRangeData.filter(function(item) {
      var flag = true;
      keyIndex.forEach(key =>{
        flag = flag && (item[key].toString().toLowerCase()==row[0][key].toString().toLowerCase());
        if (!flag) return;
      });
      return flag;
    });

  if (mode == CMD_ROW_DELETE)  {
    sheetData.deleteRow(index+2);
  } 
}

function prepareSheetsAndColumns()
{
  //–æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ª–∏—Å—Ç—ã
  var DOC = SpreadsheetApp.openById(DOC_ID);
  var sheetIndex=0;
  SHEETS_TO_CREATE.forEach(item=>{
    var sheet = DOC.getSheetByName(item);
    if (sheet == null) 
    {
      sheet = DOC.insertSheet();
      sheet.setName(item);
    }

    //–§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –ª–∏—Å—Ç–∞—Ö
    var j=1;
    COLUMNS_ARRAY[sheetIndex].forEach(item=>{
    if (sheet.getRange(1,j,1,1).getValue().toString() != item) sheet.getRange(1,j,1,1).setValue(item);
    j++;
  }); 

    sheetIndex ++;
  });
}

//—Ñ—É–Ω–∫—Ü–∏—è –∏—â–µ—Ç –∏ —Å–∫–∏–¥—ã–≤–∞–µ—Ç –≤ –∞—Ä—Ö–∏–≤ —Å—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã. –ï—Å–ª–∏ –Ω–∞ clientTgChatId –µ—Å—Ç—å –∑–∞–∫—Ä—ã—Ç—ã–µ –∑–∞–∫–∞–∑—ã –∏ –∞ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –±–æ–ª—å—à–µ max_archive_length
//—Ç–∞–∫–∂–µ –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ –∑–∞–∫–∞–∑–∞–º –≤ —Ä–∞–±–æ—Ç–µ
//—Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É —Ä–∞–∑ –≤ –¥–µ–Ω—å
function archiveOldOrders()
{
  //–ø–æ–¥–∫–ª—é—á–∞–µ–º moment.js –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
  eval(UrlFetchApp.fetch(MOMENTJS_link).getContentText());

  var count_active_orders = 0; //—Ç—É—Ç –ø–æ—Å—á–∏—Ç–∞–µ–º –∫–æ–ª-–≤–æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.
  var count_ispay_orders = 0; //—Ç—É—Ç –ø–æ—Å—á–∏—Ç–∞–µ–º –∫–æ–ª-–≤–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.
  var count_not_accepted_orders = 0; //—Ç—É—Ç –ø–æ—Å—á–∏—Ç–∞–µ–º –∫–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–æ–≤.

  var order_rows = null;
  //—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã —Å –ª–∏—Å—Ç–∞
  order_rows = updateTableRow( ORDER_SHEET_NAME, [Array(COLUMNS_ARRAY[ORDER_SHEET_INDEX].length).fill("")], [], CMD_ROW_FILTER);
  if (order_rows != null) 
  {
    console.log("–ù–∞–π–¥–µ–Ω–æ: "+order_rows.length+" –∑–∞–∫–∞–∑–æ–≤.");

    //–æ–±—Ä–∞–±–æ—Ç–∫–∞
    var flag = true;
    while (flag)
    {
      flag = false;
      count_active_orders = 0;
      count_ispay_orders = 0;
      count_not_accepted_orders = 0;
      order_rows.forEach(row => {
        var UID = 0;
        try
        {UID = parseInt(row[0]);}
        catch(e){};        
        
        if (UID>0)
        {
          var order = JSON.parse(row[4]);
          if (!order.isAccepted) count_not_accepted_orders+=1;
          if (!order.isCompleted && !order.isCancelled) count_active_orders+=1;
          if (!order.isCompleted && !order.isCancelled && !order.isClientPay) count_ispay_orders+=1;

          if (order && order.isCompleted == true || order.isCancelled == true)
          {
            var count = order_rows.filter(p=> parseInt(p[0])>0 && (JSON.parse(p[4]).clientTgChatId == order.clientTgChatId)).length;
            if (count > max_archive_length){
              flag = true;
              //–º–µ–Ω—è–µ–º –∫–æ–¥ –∑–∞–ø–∏—Å–∏ –Ω–∞ –º–∏–Ω—É—Å, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —Å–±—Ä–æ—Å–∏—Ç—å –≤ –∞—Ä—Ö–∏–≤ –∏ —É–¥–∞–ª–∏—Ç—å —Å –ª–∏—Å—Ç–∞
              row[0] = -Math.abs(row[0]);              
            }
          }
        }
      });
    }

    if (count_active_orders>0){
      KEYBOARD_ON_CHAT_ADMIN = {}; 
      KEYBOARD_ON_CHAT_ADMIN.parse_mode = "HTML"
      KEYBOARD_ON_CHAT_ADMIN.inline_keyboard = [];    
      var index = 0;

      index = KEYBOARD_ON_CHAT_ADMIN.inline_keyboard.length;
      KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index] = [];
      KEYBOARD_ON_CHAT_ADMIN.inline_keyboard[index][0] = {
        text:   "üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤",
        web_app: {"url": WEB_APP_URL+"/orders"}
      };
      //send_key("üí¨ <b>–°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</b>: \n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ - "+count_active_orders+""+
      //((count_not_accepted_orders>0)?(", –∏–∑ –Ω–∏—Ö "+count_not_accepted_orders+" –æ–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ"):(""))+
      //".\n–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –≤–æ–≤—Ä–µ–º—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã –∏ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—è—Ç—å –∏—Ö, —á—Ç–æ–±—ã –Ω–µ –∑–∞–º–µ–¥–ª—è–ª–∞—Å—å —Ä–∞–±–æ—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã.", chat_id_master, KEYBOARD_ON_CHAT_ADMIN);                             
      chat_id_master.toString().split(';').forEach(chat_id_item=>{
        if ((""+chat_id_item.trim()).length >0){
          send_key("üí¨ <b>–°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</b>: \n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ - "+count_active_orders+""+
          ((count_not_accepted_orders>0)?(", –∏–∑ –Ω–∏—Ö "+count_not_accepted_orders+" –æ–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ"):(""))+
          ((count_ispay_orders>0)?(", –∏–∑ –Ω–∏—Ö "+count_ispay_orders+" –æ–ø–ª–∞—á–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–º —á–µ—Ä–µ–∑ Telegram"):(""))+
          ".\n–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –≤–æ–≤—Ä–µ–º—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã –∏ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—è—Ç—å –∏—Ö, —á—Ç–æ–±—ã –Ω–µ –∑–∞–º–µ–¥–ª—è–ª–∞—Å—å —Ä–∞–±–æ—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã.", chat_id_item, KEYBOARD_ON_CHAT_ADMIN);
        }
      });
    }

    var DOC = SpreadsheetApp.openById(DOC_ID);
    var sheet = DOC.getSheetByName(ORDER_SHEET_NAME);
    var sheet_archive = DOC.getSheetByName(ARCHIVE_ORDER_SHEET_NAME);
    
    var index = 0;
    var archive_rows = [];

    order_rows.forEach(row => {
      //–µ—Å–ª–∏ –º–µ–Ω—å—à–µ 0 —Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ª–∏—Å—Ç –∞—Ä—Ö–∏–≤–∞
      if (parseInt(row[0])<0)
      {
        //console.log(row[0]);
        var order = JSON.parse(row[4]);
        var j = 0;
        
        index = archive_rows.length;
        archive_rows[index] = [];
        //–ø–µ—Ä–≤—ã–µ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ —ç—Ç–æ –∫–æ–¥ –∏ JSON, –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–∞—Å–∏–º
        archive_rows[index][0]="";
        archive_rows[index][1]=row[4];
        
        COLUMNS_ARRAY[ARCHIVE_ORDER_SHEET_INDEX].forEach(archive_column =>
        {
          if (j == 0) archive_rows[index][0]="";
          else
          if (j == 1) archive_rows[index][1]=row[4];
          else
          {
            var col_name = archive_column.split('#')[1];
            if (col_name && order.hasOwnProperty(col_name)) 
            {
              if (col_name == "items") {
                var items_str = "";
                var item_index = 1;
                order[col_name].forEach(item=>{
                  items_str += ((item_index>1)?("\n"):(""))+item_index+") "+item.product.name+" "+((item.product.artikul)?("–∞—Ä—Ç."+item.product.artikul):(""))+" "+item.quantity+" —à—Ç. –ø–æ "+((item.product.price / 100) * (100 - item.product.discount))+" —Ä—É–±."+((item.product.discount>0)?(" —Å–æ —Å–∫–∏–¥–∫–æ–π "+item.product.discount+"%"):(""));
                  item_index++;
                });
                archive_rows[index][j] = items_str;//JSON.stringify(order[col_name]);
              }
              else
              {
                if (col_name.toLowerCase().indexOf("date")>=0) 
                  archive_rows[index][j] = moment(order[col_name].toString()).format('DD.MM.YYYY HH:mm:ss');//new Date(order[col_name])
                else
                 archive_rows[index][j] = order[col_name];
              }
            }
            else
              archive_rows[index][j] = "";
          }
          j++;
        })        
        //console.log(archive_rows[index]);
      }
    });

    if (archive_rows.length>0) 
    {
      //  console.log(archive_rows[0].length);
      //  return;
      //—Å–∫–∏–¥—ã–≤–∞–µ–º –≤ –∞—Ä—Ö–∏–≤ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ
      updateTableRow( ARCHIVE_ORDER_SHEET_NAME, archive_rows, [], CMD_ROW_INSERT);

      //–∑–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º —Å –ª–∏—Å—Ç–∞ –∑–∞–∫–∞–∑–æ–≤
      order_rows.forEach(row =>{
        if (parseInt(row[0])<0)
        {
          row[0] = Math.abs(row[0]);
          //—É–¥–∞–ª—è–µ–º —Å –ª–∏—Å—Ç–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ
          updateTableRow( ORDER_SHEET_NAME, [row], [0], CMD_ROW_DELETE);
        }
      });

      //send("üí¨ <b>–°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</b>: –í –∞—Ä—Ö–∏–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ "+archive_rows.length+" –∑–∞–∫–∞–∑–æ–≤.", chat_id_master);                           
      chat_id_master.toString().split(';').forEach(chat_id_item=>{
        if ((""+chat_id_item.trim()).length >0){
          send("üí¨ <b>–°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</b>: –í –∞—Ä—Ö–∏–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ "+archive_rows.length+" –∑–∞–∫–∞–∑–æ–≤.", chat_id_item);                           
        }
      });
    }
  }
  
}

function formatPhoneNumber(phone)
{
  if (phone.toString().length == 10) return "+7"+phone;
  else return phone;
}

function udpateAllCartItems(product){
  var cart_rows = updateTableRow( CART_SHEET_NAME, [Array(COLUMNS_ARRAY[CART_SHEET_INDEX].length).fill("")], [], CMD_ROW_FILTER);
  if (cart_rows != null) 
  {
    
    cart_rows.forEach(row =>{
      var totalAmount = 0;
      
      var cart = JSON.parse(row[4]);
      var flag = false;
      cart.items.forEach(item=>{
        if (item.product.id == product.id && item.product.price != product.price) {
          flag = true;          
          totalAmount = totalAmount + product.price*item.quantity;
          item.product = product;

        }
        else
        totalAmount = totalAmount + item.product.price*item.quantity;
      });

      if (flag){
        cart.totalAmount = totalAmount;
        //console.log(cart);
        row[4] = JSON.stringify(cart);
        console.log("–û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è "+row[0]);
        updateTableRow( CART_SHEET_NAME, [row], [0], CMD_ROW_UPDATE);
      }       
    });


  }
}

//—É–¥–∞–ª—è–µ–º –Ω–∞–¥–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
function clearSheetsData()
{
  return;
  //–æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ª–∏—Å—Ç—ã
  var DOC = SpreadsheetApp.openById(DOC_ID);
  SHEETS_TO_CREATE.forEach(item=>{
    var sheet = DOC.getSheetByName(item);
    if (sheet == null) 
    {
      sheet = DOC.insertSheet();
      sheet.setName(item);
    }
  });

  // //–§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –ª–∏—Å—Ç–∞—Ö
  // var sheetDostup = DOC.getSheetByName('–î–æ—Å—Ç—É–ø'); 
  
  // //—Ñ–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫    
  // var j=1;
  // DOSTUP_COLUMNS.forEach(item=>{
  //   if (sheetDostup.getRange(1,j,1,1).getValue().toString() != item) sheetDostup.getRange(1,j,1,1).setValue(item);
  //   j++;
  // }); 


  // var sheetSession = DOC.getSheetByName('–°–µ—Å—Å–∏—è'); 
  
  // //—Ñ–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫    
  // var j=1;
  // SESSION_COLUMNS.forEach(item=>{
  //   if (sheetSession.getRange(1,j,1,1).getValue().toString() != item) sheetSession.getRange(1,j,1,1).setValue(item);
  //   j++;
  // }); 

  // var sheetOffice = DOC.getSheetByName('–û—Ñ–∏—Å'); 
  
  // //—Ñ–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫    
  // var j=1;
  // OFFICE_COLUMNS.forEach(item=>{
  //   if (sheetOffice.getRange(1,j,1,1).getValue().toString() != item) sheetOffice.getRange(1,j,1,1).setValue(item);
  //   j++;
  // }); 
}

function getProductsParams(productName, brand){
  var productCategory = '';
  var productType = '';
  var productBrand = '';
  var productBrandLine = '';
  var productBrandSeries = '';

  //1. –ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –∂–µ–Ω—â–∏–Ω  
  //  1.1. –£—Ö–æ–¥ –∑–∞ –≤–æ–ª–æ—Å–∞–º–∏
  //  1.2. –û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ
  //  1.3. –û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ –±—Ä–æ–≤–µ–π
  //  1.4. –°—Ç–∞–π–ª–∏–Ω–≥
  //  1.5. –ó–∞–≤–∏–≤–∫–∞ –∏ –≤—ã–ø—Ä—è–º–ª–µ–Ω–∏–µ
  //  1.6. –£—Ö–æ–¥ –∑–∞ —Ç–µ–ª–æ–º
  //  1.7. –£—Ö–æ–¥ –∑–∞ –ª–∏—Ü–æ–º
  //  1.8. –ü–∞—Ä—Ñ—é–º
  //  1.9. –ù–∞–±–æ—Ä—ã
  //  –õ–∏–Ω–µ–π–∫–∏ –∏ —Å–µ—Ä–∏–∏
  //    1. Otium
  //    1.1. Aqua
  //2. –ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –º—É–∂—á–∏–Ω
  //  2.1. –£—Ö–æ–¥ –∑–∞ –≤–æ–ª–æ—Å–∞–º–∏
  //  2.2. –ö–∞–º—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ª–æ—Å
  //  2.3. –°—Ç–∞–ª–∏–Ω–≥
  //  2.4. –£—Ö–æ–¥ –∑–∞ —Ç–µ–ª–æ–º
  //  2.5. –£—Ö–æ–¥ –∑–∞ –ª–∏—Ü–æ–º
  //    2.5.1 Alpha Homme
  //    2.5.1.1 Aqua
  //  2.6. –ü–∞—Ä—Ñ—é–º
  //  2.7. –ù–∞–±–æ—Ä—ã  
  //  –õ–∏–Ω–µ–π–∫–∏ –∏ —Å–µ—Ä–∏–∏
  //    1. Alpha Homme
  //    2. Alpha Marine
  //    3. Genwood
  //3. –ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –¥–µ—Ç–µ–π
  //4. –ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
  //5. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã

  /*****
   * 
   * 
   * 
   * 
   * –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * 
   * 
   * 
   * 
   */

  //1. –ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –∂–µ–Ω—â–∏–Ω 
  if((productCategory=="") && 
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('otium')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('haute couture')>=0)
    ))
  {
    productCategory = "–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –∂–µ–Ω—â–∏–Ω";
  }  
  
  //2. –ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –º—É–∂—á–∏–Ω 
  if((productCategory=="") && 
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('alpha')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–∞lpha')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('homme')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–Ωomme')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('gentleman')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–∞–ª—å—Ñ–∞')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('curex active')>=0)
    ))
  {
    productCategory = "–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –º—É–∂—á–∏–Ω";
  }
  
  //3. –ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –¥–µ—Ç–µ–π 
  if((productCategory=="") && 
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('little me')>=0)
    ))
  {
    productCategory = "–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –¥–µ—Ç–µ–π";
  }  

  //4. –ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã 
  if((productCategory=="") && 
    (
      ((""+productName).toLowerCase().indexOf('—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç')>=0)
    ))
  {
    productCategory = "–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã";
  } 

  //5. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã 
  if((productCategory=="") && 
    (
      ((""+productName).toLowerCase().indexOf('–∫–∏—Å—Ç–æ—á–∫–∞')>=0)
    ))
  {
    productCategory = "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã";
  }

  //6. –ù–ï –ù–ê–ô–î–ï–ù–û
  if (productCategory=="") //–µ—Å–ª–∏ –Ω–µ –ø–æ–ø–∞–ª–æ –≤ –¥—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  {
    productCategory = "";
  }

  /*****
   * 
   * 
   * 
   * 
   * –¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞
   * –ö–∞—Ç–µ–≥–æ—Ä–∏—è "–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –∂–µ–Ω—â–∏–Ω"
   * 
   * 
   * 
   */

  //  1.9. –ù–∞–±–æ—Ä—ã 
  if((productType=="") && 
  (productCategory=="–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –∂–µ–Ω—â–∏–Ω") &&
    (
      ((""+productName).toLowerCase().indexOf('–Ω–∞–±–æ—Ä')>=0)
    ))
  {
    productType = "–ù–∞–±–æ—Ä—ã";
  }

  //  1.1 –£—Ö–æ–¥ –∑–∞ –≤–æ–ª–æ—Å–∞–º–∏ 
  if((productType=="") && 
  (productCategory=="–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –∂–µ–Ω—â–∏–Ω") &&
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('otium')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('moloko')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–∑–∞—Ä—è–¥–∏')>=0)
    ))
  {
    productType = "–£—Ö–æ–¥ –∑–∞ –≤–æ–ª–æ—Å–∞–º–∏";
  }

  
  /*****
   * 
   * 
   * 
   * 
   * –¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞
   * –ö–∞—Ç–µ–≥–æ—Ä–∏—è "–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –º—É–∂—á–∏–Ω"
   * 
   * 
   * 
   */
  //  2.7. –ù–∞–±–æ—Ä—ã 
  if((productType=="") && 
  (productCategory=="–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –º—É–∂—á–∏–Ω") &&
    (
      ((""+productName).toLowerCase().indexOf('–Ω–∞–±–æ—Ä')>=0)
    ))
  {
    productType = "–ù–∞–±–æ—Ä—ã";
  }  

  //  2.2. –ö–∞–º—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ª–æ—Å
  if((productType=="") && 
  (productCategory=="–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –º—É–∂—á–∏–Ω") &&
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–∫—Ä–∞—Å–∫–∞')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–æ–∫—Å–∏–≥–µ–Ω—Ç')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–æ–∫—Å–∏–¥–∞–Ω—Ç')>=0)
    ))
  {
    productType = "–ö–∞–º—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ª–æ—Å";
  }

  //  2.5. –£—Ö–æ–¥ –∑–∞ –ª–∏—Ü–æ–º
  if((productType=="") && 
  (productCategory=="–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –º—É–∂—á–∏–Ω") &&
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–±—Ä–∏—Ç—å')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–ª–∏—Ü–∞')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–±–æ—Ä–æ–¥—ã')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–≥–ª–∞–∑')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–¥–ª—è –≥—É–±')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–∑—É–±–Ω–∞—è –ø–∞—Å—Ç–∞')>=0)
    ))
  {
    productType = "–£—Ö–æ–¥ –∑–∞ –ª–∏—Ü–æ–º";
  }


  //  2.1. –£—Ö–æ–¥ –∑–∞ –≤–æ–ª–æ—Å–∞–º–∏
  if((productType=="") && 
  (productCategory=="–ö–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –º—É–∂—á–∏–Ω") &&
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('—Å—ã–≤–æ—Ä–æ—Ç–∫–∞')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('—à–∞–º–ø—É–Ω—å')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–≤–æ–ª–æ—Å')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–±–∞–ª—å–∑–∞–º')>=0)
    ))
  {
    productType = "–£—Ö–æ–¥ –∑–∞ –≤–æ–ª–æ—Å–∞–º–∏";
  }

  

  /*****
   * 
   * 
   * 
   * 
   *  –õ–∏–Ω–µ–π–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
   * 
   * 
   * 
   * 
   */

  //    Otium 
  if((productBrandLine=="") && 
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('otium')>=0)
    ))
  {
    productBrandLine = "Otium";
  }

  //  Alpha Professional   
  if((productBrandLine=="") && 
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('alpha pro')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–∞lpha pro')>=0)
    ))
  {
    productBrandLine = "Alpha Professional";
  }

  //  Alpha Homme   
  if((productBrandLine=="") && 
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('alpha')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–∞lpha')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('homme')>=0)
      ||((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–Ωomme')>=0)
    ))
  {
    productBrandLine = "Alpha Homme";
  }

  //  Alpha Marine   
  if((productBrandLine=="") && 
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('alpha marine')>=0)
    ))
  {
    productBrandLine = "Alpha Marine";
  }

  //  Genwood   
  if((productBrandLine=="") && 
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('genwood')>=0)
    ))
  {
    productBrandLine = "Genwood";
  }

  

  /*****
   * 
   * 
   * 
   * 
   *  –°–µ—Ä–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * 
   * 
   * 
   * 
   */ 

  //      Otium - Aqua 
  if((productBrandSeries=="") && 
  (productBrandLine=="Otium") &&
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('aqua')>=0)
    ))
  {
    productBrandSeries = "Aqua";
  }

  //      Otium - –ó–∞—Ä—è–¥–∏ 
  if((productBrandSeries=="") && 
  (productBrandLine=="Otium") &&
    (
      ((brand.toString().toLowerCase()=="estel") && (""+productName).toLowerCase().indexOf('–∑–∞—Ä—è–¥–∏')>=0)
    ))
  {
    productBrandSeries = "–ó–∞—Ä—è–¥–∏";
  }



  return {
    category: productCategory,
    type: productType,
    brandLine: productBrandLine,
    brandSeries: productBrandSeries
  }
}


function ParseDataFromHTML() {
  //–∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫
  var colId        = 0;
  var colUrl          = 1;
  var colArtikul      = 2;
  var colCategory     = 3;
  var colType         = 4;
  var colBrand        = 5;
  var colBrandLine    = 6;
  var colBrandSeries  = 7;
  var colName         = 8;
  var colDescription  = 9;
  var colDopolnitelno = 10;
  var colImageUrl     = 11;
  var colPrice        = 12;
  var colDiscount     = 13;
  var colIsNew        = 14;
  // var colArtikul2     = 15;
  // var colImageUrl2    = 16;

  //–≤—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫
  var numColsReport = colIsNew+1;

  var spreadsheet = SpreadsheetApp.openById(DOC_ID);
  var worksheet   = spreadsheet.getSheetByName(PRODUCT_SHEET_NAME);
  var rows        = worksheet.getDataRange().getNumRows(); //—á–∏—Å–ª–æ —Å—Ç—Ä–æ–∫ –Ω–∞ –ª–∏—Å—Ç–µ  
  var vals        = worksheet.getSheetValues(1, 1, rows, numColsReport);  //–¥–∏–∞–ø–∞–∑–æ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  Logger.log(vals.length);

  var secondProduct = []; //—Ç—É—Ç –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –≤—Ç–æ—Ä–∏—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤

  for (var row = 1; row < vals.length; row++) {

    var changed = false;
    //Logger.log(vals[row][colId]);
    
    try {
      var url = vals[row][colUrl];
      var msgProductUpdate ="";
      


      //Logger.log(vals[row][6]+" "+worksheet.getRange(row+1,7).getValue());

      //–ï—Å–ª–∏ –ø–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥—É–∫—Ç–µ —Å —Å–∞–π—Ç–∞ —Ü–µ–∫–æ –∏ –∏–º—è –ø—Ä–æ–¥—É–∫—Ç–∞ –ø—É—Å—Ç–æ–µ
      if ((""+vals[row][colName]).length === 0 
      // || (""+vals[row][colArtikul]).length === 0 
      // || (""+vals[row][colCategory]).length === 0 
      // || (""+vals[row][colType]).length === 0 
      // || (""+vals[row][colBrand]).length === 0 
      // || (""+vals[row][colImageUrl]).length === 0 
      // || (""+vals[row][colDiscount]).length === 0 
      // || (""+vals[row][colIsNew]).length === 0 
      // || (""+vals[row][colPrice]).length === 0 
      // || (""+vals[row][colDescription]).length === 0
      // || (""+vals[row][colDopolnitelno]).length === 0
      )


      if ((""+url).indexOf("https://cehko.ru") >= 0)
      {
        Logger.log("–°—Ç—Ä–æ–∫–∞ (cehko.ru) —Å ‚Ññ: "+ vals[row][colId]);
        changed = true;
        const contentText = UrlFetchApp.fetch(url).getContentText();
        const $ = Cheerio.load(contentText);    
        
        if ((""+vals[row][colBrand]).length === 0) vals[row][colBrand] = 'C:EHKO';
        if ((""+vals[row][colName]).length === 0) vals[row][colName] = $('.changeShortDescription').first().text();

        
        Logger.log($('.changeDescription').text());  
        if ((""+vals[row][colDescription]).length === 0) vals[row][colDescription] = $('.changeDescription').children().after('\n').parent().text();
        if ((""+vals[row][colDescription]).length === 0) vals[row][colDescription] = $('.changeDescription').text();
        // .each(function (i, elem) {            
        //   vals[row][colDescription] += (((""+vals[row][colDescription]).length > 0)?("\n"):(""))+$(this).text().trim();
        // });
        if ((""+vals[row][colImageUrl]).length === 0) vals[row][colImageUrl] = "https://cehko.ru"+$('.zoom').first().attr().href;
        if ((""+vals[row][colDiscount]).length === 0) vals[row][colDiscount] = 0;
        if ((""+vals[row][colPrice]).length === 0) vals[row][colPrice] = 0;
        if ((""+vals[row][colIsNew]).length === 0) vals[row][colIsNew] = "–ù–µ—Ç";

        //Logger.log("https://cehko.ru"+$('.zoom').attr().href);

        if ((""+vals[row][colType]).length === 0) {
          const $trs = $('.stats').children('tbody').find('tr');
          $trs.each((index, element)=>{
            if ($(element).text().toLowerCase().indexOf('—Ç–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞')>=0)
            {
              vals[row][colType] = $(element).children('td:nth(1)').text();              
              Logger.log($(element).children('td:nth(1)').text());
            }
          });
          if ((""+vals[row][colType]).length === 0)
          {
            if ((""+vals[row][colName]).toLowerCase().indexOf('—à–∞–º–ø—É–Ω—å')>=0)
            {
              vals[row][colType] = "—à–∞–º–ø—É–Ω—å";
              Logger.log(vals[row][colType]);
            }
            else
            if ((""+vals[row][colName]).toLowerCase().indexOf('–∫—Ä–∞—Å–∫–∞')>=0)
            {
              vals[row][colType] = "–∫—Ä–∞—Å–∫–∞";
              Logger.log(vals[row][colType]);
            }
          }           
        }

        

        if ((""+vals[row][colCategory]).length === 0) {
          const $trs = $('.stats').children('tbody').find('tr');
          $trs.each((index, element)=>{
            if ($(element).text().toLowerCase().indexOf('–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ')>=0)
            {
              vals[row][colCategory] = $(element).children('td:nth(1)').text();              
              Logger.log($(element).children('td:nth(1)').text());
            }
          }); 
          if ((""+vals[row][colCategory]).length === 0)
          {
            if ((""+vals[row][colName]).toLowerCase().indexOf('—à–∞–º–ø—É–Ω—å')>=0)
            {
              vals[row][colCategory] = "—É—Ö–æ–¥";
              Logger.log(vals[row][colCategory]);
            }
            else
            if ((""+vals[row][colName]).toLowerCase().indexOf('–∫—Ä–∞—Å–∫–∞')>=0)
            {
              vals[row][colCategory] = "–æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ";
              Logger.log(vals[row][colCategory]);
            }
          }         
        }

        if ((""+vals[row][colArtikul]).length === 0) {
          const $trs = $('.stats').children('tbody').find('tr');
          $trs.each((index, element)=>{
            if ($(element).text().toLowerCase().indexOf('–∞—Ä—Ç–∏–∫—É–ª')>=0)
            {
              vals[row][colArtikul] = $(element).children('td:nth(1)').text();              
              Logger.log($(element).children('td:nth(1)').text());
            }
          });          
        }        

        if ((""+vals[row][colDopolnitelno]).length === 0) {          
          const $trs = $('.stats').children('tbody').find('tr');
          $trs.each((index, element)=>{
            if ($(element).text().toLowerCase().indexOf('–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å')>=0)
            {              
              vals[row][colDopolnitelno] +=(((""+vals[row][colDopolnitelno]).length > 0)?("\n"):("")) +$(element).children('td:nth(0)').text().trim()+": "+ $(element).children('td:nth(1)').text().trim();              
              Logger.log($(element).children('td:nth(0)').text()+": "+ $(element).children('td:nth(1)').text());              
            } else

            if ($(element).text().toLowerCase().indexOf('–≤–µ—Å (–≥—Ä–∞–º–º)')>=0)
            {              
              vals[row][colDopolnitelno] +=(((""+vals[row][colDopolnitelno]).length > 0)?("\n"):("")) +$(element).children('td:nth(0)').text().trim()+": "+ $(element).children('td:nth(1)').text().trim();              
              Logger.log($(element).children('td:nth(0)').text()+": "+ $(element).children('td:nth(1)').text());              
            } else

            if ($(element).text().toLowerCase().indexOf('—Ç–∏–ø –≤–æ–ª–æ—Å')>=0)
            {              
              vals[row][colDopolnitelno] +=(((""+vals[row][colDopolnitelno]).length > 0)?("\n"):("")) +$(element).children('td:nth(0)').text().trim()+": "+ $(element).children('td:nth(1)').text().trim();              
              Logger.log($(element).children('td:nth(0)').text()+": "+ $(element).children('td:nth(1)').text());              
            } else

            if ($(element).text().toLowerCase().indexOf('–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ')>=0)
            {              
              vals[row][colDopolnitelno] +=(((""+vals[row][colDopolnitelno]).length > 0)?("\n"):("")) +$(element).children('td:nth(0)').text().trim()+": "+ $(element).children('td:nth(1)').text().trim();              
              Logger.log($(element).children('td:nth(0)').text()+": "+ $(element).children('td:nth(1)').text());              
            }
            else

            if ($(element).text().toLowerCase().indexOf('–ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ')>=0)
            {              
              vals[row][colDopolnitelno] +=(((""+vals[row][colDopolnitelno]).length > 0)?("\n"):("")) +$(element).children('td:nth(0)').text().trim()+": "+ $(element).children('td:nth(1)').text().trim();              
              Logger.log($(element).children('td:nth(0)').text()+": "+ $(element).children('td:nth(1)').text());              
            }
          });          
        }        
      }






      


      //–ï—Å–ª–∏ –ø–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥—É–∫—Ç–µ —Å —Å–∞–π—Ç–∞ –≠—Å—Ç–µ–ª—å –∏ –∏–º—è –ø—Ä–æ–¥—É–∫—Ç–∞ –ø—É—Å—Ç–æ–µ
      if ((""+vals[row][colName]).length === 0 
      // || (""+vals[row][colArtikul]).length === 0 
      // || (""+vals[row][colCategory]).length === 0 
      // || (""+vals[row][colType]).length === 0 
      // || (""+vals[row][colBrand]).length === 0 
      // || (""+vals[row][colImageUrl]).length === 0 
      // || (""+vals[row][colDiscount]).length === 0 
      // || (""+vals[row][colIsNew]).length === 0 
      // || (""+vals[row][colPrice]).length === 0 
      // || (""+vals[row][colDescription]).length === 0
      // || (""+vals[row][colDopolnitelno]).length === 0
      )

      if ((""+url).indexOf("https://estel.pro") >= 0)
      {
        Logger.log("–°—Ç—Ä–æ–∫–∞ (estel.pro) —Å ‚Ññ: "+ vals[row][colId]);
        msgProductUpdate ="";
        var isSecondProductLoaded = false;
        changed = true;
        const contentText = UrlFetchApp.fetch(url).getContentText();
        const $ = Cheerio.load(contentText);                
        
        if ((""+vals[row][colBrand]).length === 0) {vals[row][colBrand] = 'ESTEL'; 
          msgProductUpdate+="Brand: "+vals[row][colBrand]+";\n"}

        if ((""+vals[row][colName]).length === 0) {vals[row][colName] = $('.card-sub-title').first().text(); 
          msgProductUpdate+="Name: "+vals[row][colName]+";\n"}
        //Logger.log( $('.card-sub-title').first().text());    

        if ((""+vals[row][colArtikul]).length === 0) {
          const $trs = $('.product-param-content');
          $trs.each((index, element)=>{
            if ($(element).children('.product-param-title').first().text().toLowerCase().indexOf('–∞—Ä—Ç–∏–∫—É–ª')>=0)
            {
              vals[row][colArtikul] = $(element).children('.product-param-text').first().text(); 
              //Logger.log($(element).children('.product-param-text').first().text());
            }
          });

          if (vals[row][colArtikul].toString().split(';').length>1)
          {
            index2 = secondProduct.length;
            secondProduct[index2] = vals[row].reduce((newArray, element) => {
              newArray.push(element);
              return newArray;
            }, []);

            secondProduct[index2][colId] = 0;
            secondProduct[index2][colArtikul] = vals[row][colArtikul].toString().split(';')[1].trim();
            secondProduct[index2][colName] = vals[row][colName];
            secondProduct[index2][colBrand] = vals[row][colBrand];
            vals[row][colArtikul] = vals[row][colArtikul].toString().split(';')[0].trim();
            isSecondProductLoaded = true;
          } 
          msgProductUpdate+="Artikul: "+vals[row][colArtikul]+";\n"         
        } 

        
         
        if ((""+vals[row][colDescription]).length === 0) $('.card-info-text').children().each(function (i, elem) {            
           vals[row][colDescription] += (((""+vals[row][colDescription]).length > 0)?("\n"):(""))+(($(this).children().length>0)?($(this).children().after('\n').parent().text()):($(this).text().trim()));
        });
        if ((""+vals[row][colDescription]).length === 0) {vals[row][colDescription] = $('.card-info-text').text(); 
          msgProductUpdate+="Description: "+vals[row][colDescription]+";\n"}
        if (isSecondProductLoaded) secondProduct[index2][colDescription] = vals[row][colDescription];

        if ((""+vals[row][colDiscount]).length === 0) vals[row][colDiscount] = 0;
        if (isSecondProductLoaded) secondProduct[index2][colDiscount] = vals[row][colDiscount];
        if ((""+vals[row][colPrice]).length === 0) vals[row][colPrice] = 0;
        if (isSecondProductLoaded) secondProduct[index2][colPrice] = vals[row][colPrice];
        if ((""+vals[row][colIsNew]).length === 0) vals[row][colIsNew] = "–ù–µ—Ç";
        if (isSecondProductLoaded) secondProduct[index2][colIsNew] = vals[row][colIsNew];

        // //Logger.log("https://cehko.ru"+$('.zoom').attr().href);

        var productsParameters = getProductsParams(vals[row][colName],vals[row][colBrand]);

        if ((""+vals[row][colCategory]).length === 0) {vals[row][colCategory] = productsParameters.category;
          msgProductUpdate+="Category: "+vals[row][colCategory]+";\n"}  
        if ((""+vals[row][colType]).length === 0) {vals[row][colType] = productsParameters.type;
          msgProductUpdate+="Type: "+vals[row][colType]+";\n"}  
        if ((""+vals[row][colBrandLine]).length === 0) {vals[row][colBrandLine] = productsParameters.brandLine;
          msgProductUpdate+="BrandLine: "+vals[row][colBrandLine]+";\n"}  
        if ((""+vals[row][colBrandSeries]).length === 0) {vals[row][colBrandSeries] = productsParameters.brandSeries;
          msgProductUpdate+="BrandSeries: "+vals[row][colBrandSeries]+";\n"}  
        if (isSecondProductLoaded) secondProduct[index2][colCategory] = vals[row][colCategory];
        if (isSecondProductLoaded) secondProduct[index2][colType] = vals[row][colType];
        if (isSecondProductLoaded) secondProduct[index2][colBrandLine] = vals[row][colBrandLine];
        if (isSecondProductLoaded) secondProduct[index2][colBrandSeries] = vals[row][colBrandSeries];

        
             

        if ((""+vals[row][colDopolnitelno]).length === 0) {          
          const $trs =$('.product-param-content');
          $trs.each((index, element)=>{
            if ($(element).children('.product-param-title').first().text().toLowerCase().indexOf('–æ–±—ä—ë–º')>=0)
            {              
                

              if (isSecondProductLoaded && $(element).children('.product-param-text').first().text().trim().split(';').length>1){
                var firstV = $(element).children('.product-param-text').first().text().trim().split(';')[0].trim();
                var secondV = $(element).children('.product-param-text').first().text().trim().split(';')[1].trim();
                vals[row][colDopolnitelno] +=(((""+vals[row][colDopolnitelno]).length > 0)?("\n"):("")) +$(element).children('.product-param-title').first().text().trim()+" "+ firstV;
                secondProduct[index2][colDopolnitelno] +=(((""+secondProduct[index2][colDopolnitelno]).length > 0)?("\n"):("")) +$(element).children('.product-param-title').first().text().trim()+" "+ secondV;
                vals[row][colName] = vals[row][colName]+" ("+firstV+")";
                secondProduct[index2][colName] = secondProduct[index2][colName]+" ("+secondV+")";
              }
              else
              vals[row][colDopolnitelno] +=(((""+vals[row][colDopolnitelno]).length > 0)?("\n"):("")) +$(element).children('.product-param-title').first().text().trim()+" "+ $(element).children('.product-param-text').first().text().trim();
              //Logger.log($(element).children('.product-param-title').first().text().trim()+" "+ $(element).children('.product-param-text').first().text().trim());              
            }

            
          }); 
          msgProductUpdate+="Dopolnitelno: "+vals[row][colDopolnitelno]+";\n"             
        }  

        //Logger.log("!"+($('.rsImg').length>0 && true));
        if ((""+vals[row][colImageUrl]).length === 0 && $('.rsImg').length>0) {vals[row][colImageUrl] = "https://estel.pro"+$('.rsImg').first().attr().href; 
          msgProductUpdate+="ImageUrl: "+vals[row][colImageUrl]+";\n"}       
        if ((""+vals[row][colImageUrl]).length === 0 && $('.card-img-wrap-single').children('img').length>0) {vals[row][colImageUrl] = "https://estel.pro"+$('.card-img-wrap-single').children('img').first().attr().src;
          msgProductUpdate+="ImageUrl: "+vals[row][colImageUrl]+";\n"}  
        if (isSecondProductLoaded){
          secondProduct[index2][colImageUrl] = vals[row][colImageUrl];
          if ($('.rsImg').length>1){
            var index = 0;
            $('.rsImg').each(function(i, elm) {
              if (index == 1) secondProduct[index2][colImageUrl] = "https://estel.pro"+$(this).attr().href;              
              index++;
            });
          }
          //–µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ 1000 –º–ª –ø—Ä–∏—Ü–µ–ø–∏–ª–∞—Å—å –∫ –¥—Ä—É–≥–æ–º—É –ø—Ä–æ–¥—É–∫—Ç—É —Ç–æ –º–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
          //Logger.log(secondProduct[index2][colImageUrl].toString().indexOf('1000'));
          if ((secondProduct[index2][colImageUrl].toString().indexOf('1000')>=0 && secondProduct[index2][colName].toString().indexOf('1000')<0) 
          || (vals[row][colImageUrl].toString().indexOf('1000')>=0 && vals[row][colName].toString().indexOf('1000')<0))
          {
            Logger.log("–ú–µ—è–Ω–µ–º");
            var tempUrl = secondProduct[index2][colImageUrl].toString();
            secondProduct[index2][colImageUrl] = vals[row][colImageUrl];
            vals[row][colImageUrl] = tempUrl;
          }
        }

       
        // //–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Ä—Ç–∏–∫—É–ª–æ–≤, –Ω–∞ —Å–∞–π—Ç–µ estel.pro –∏–Ω–æ–≥–¥–∞ (—à–∞–º–ø—É–Ω–∏ –±–∞–ª—å–∑–∞–º—ã) 250 –∏ 1000 –æ–±—ä–µ–º –ª–µ–∂–∞—Ç –≤ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ, –Ω–∞–¥–æ —Å–æ–∑–¥–∞—Ç—å –¥–≤–µ
        // if (vals[row][colArtikul].toString().split(';').length>1 && $('.rsImg').length>1){

        //   var colImageUrl2="";

        //   var index = 0;
        //   $('.rsImg').each(function(i, elm) {
        //     if (index == 1) colImageUrl2 = $(this).attr().href;
        //     //console.log($(this).attr().href) // for testing do text() 
        //     index++;
        //   });
          
        //   if((""+colImageUrl2).length > 0 && colImageUrl2.toString().toLocaleLowerCase() != vals[row][colImageUrl].toString().toLocaleLowerCase()){
            
        //     vals[row][colImageUrl] = vals[row][colImageUrl] +";"+ "https://estel.pro"+colImageUrl2; 
        //   }
            
        //   msgProductUpdate+="ImageUrl: "+vals[row][colImageUrl]+";\n"

        // }
      }

      if (msgProductUpdate.length>0)
      {
        Logger.log(msgProductUpdate);
        // Logger.log(vals[row]);
        // Logger.log(secondProduct[index2]);
      }

      //Logger.log(worksheet.getRange(row+1,1, 1, 12).getValues());
      //Logger.log(vals[row]);


      

      // var fi = vals[row][FI_COLUMN];
      // var nisha = vals[row][NISHA_COLUMN];

      // if ((""+id).length === 0 &&(""+fi).length === 0 &&(""+nisha).length === 0) k++;//–µ—Å–ª–∏ –§–ò –∏ –Ω–∏—à–∞ –∏ –Ω–æ–º–µ—Ä –ø—É—Å—Ç—ã–µ - —Å—á–∏—Ç–∞–µ–º
      // if (k>=NUM_NULL_ATTEMPTS) break;
      
      // if ((""+id).length === 0 &&(""+fi).length != 0 &&(""+nisha).length != 0) {//–§–ò –∏ –Ω–∏—à–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, –Ω–æ–º–µ—Ä –ø—É—Å—Ç–æ–π        
      //   k=0;//—Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞
      //   i++;
      //   worksheet.getRange(row+1, AUTOINC_COLUMN+1).setValue(uniqueIndex+i);//–Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä
      // }

      

    } catch(ex) {
      // Keep calm and carry on
      changed = false;
    }

    if (changed) {
      var matrix = [];
      matrix[0] = [];
      matrix[0] =vals[row];
      //Logger.log(matrix);
      worksheet.getRange(row+1,1,1, numColsReport).setValues(matrix);
      if (secondProduct.length>0)
      {        
        secondProduct.forEach(item =>{
          updateTableRow( PRODUCT_SHEET_NAME, [item], [colUrl, colArtikul], CMD_ROW_UPDATE);
        })
      }
    }
  }
  
  /*if (url == '') url = 'https://cehko.ru/catalog/care_basics_3/c_ehko_care_basics_serebristyy_shampun_silber_shampoo_250_ml/';
  const contentText = UrlFetchApp.fetch('https://cehko.ru/catalog/care_basics_3/c_ehko_care_basics_serebristyy_shampun_silber_shampoo_250_ml/').getContentText();
  const $ = Cheerio.load(contentText);

  Logger.log($('.changeShortDescription').first().text());*/

}

